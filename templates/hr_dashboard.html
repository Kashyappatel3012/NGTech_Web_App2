<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/vapt_dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Additional HR Dashboard Specific Styles */
        .section-card {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .section-card h3 {
            font-size: 1.2rem;
            color: #34495e;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .section-card h3 i {
            margin-right: 10px;
            color: #64247d;
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .action-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .action-btn i {
            font-size: 1.1rem;
        }
        
        .sub-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .sub-section h4 {
            font-size: 1rem;
            color: #555;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sub-section h4 i {
            color: #64247d;
        }
        
        .work-cards {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
        }
        
        .work-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s;
            cursor: pointer;
            width: 180px;
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        
        .work-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .work-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .work-card h3 {
            font-size: 1rem;
            margin: 0;
            font-weight: 500;
        }
        
        .work-row {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            width: 100%;
        }
        
        .update-field-btn {
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .update-field-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .update-field-btn:active {
            transform: translateY(0);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-user-tie"></i> HR Dashboard</h2>
                <p>Welcome, {{ user.employee_name }}</p>
            </div>
            <nav>
                <a href="#employee-section" class="active"><i class="fas fa-users"></i> Employee Details</a>
                <a href="#id-management-section"><i class="fas fa-id-card"></i> ID Management</a>
                <a href="#attendance-section"><i class="fas fa-calendar-check"></i> Attendance</a>
                <a href="#employee-performance-section"><i class="fas fa-chart-line"></i> Employee Performance</a>
                <a href="#broadcast-mail-section"><i class="fas fa-envelope"></i> Broadcast Mail</a>
                <a href="#catalog-section"><i class="fas fa-book"></i> Update Catalog</a>
                <a href="#work-section"><i class="fas fa-tasks"></i> Update Your Work</a>
                <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
        </div>

        <div class="main-content">
            <!-- Employee Details Section -->
            <section id="employee-section" class="dashboard-section">
                <h1><i class="fas fa-users"></i> Employee Details</h1>
                <div class="employee-container">
                    <div class="employee-card">
                        <div class="employee-info">
                            <img src="{{ url_for('static', filename='uploads/' + employee_data.photo) if employee_data and employee_data.photo else url_for('static', filename='images/default_avatar.jpg') }}" alt="Employee Photo" class="employee-img">
                            <div class="employee-details">
                                <h3>{{ user.employee_name }}</h3>
                                <p><i class="fas fa-briefcase"></i> {{ employee_data.position if employee_data else 'Position not set' }}</p>
                                <p><i class="fas fa-building"></i> {{ user.department }} Department</p>
                                <p><i class="fas fa-clock"></i> {{ employee_data.experience if employee_data else 'Experience not set' }}</p>
                            </div>
                        </div>
                        <div class="employee-additional-info">
                            <div class="info-row">
                                <span><i class="fas fa-graduation-cap"></i> <strong>Education:</strong> {{ employee_data.education if employee_data else 'Not set' }}</span>
                            </div>
                            <div class="info-row">
                                <span><i class="fas fa-certificate"></i> <strong>Certification:</strong> {{ employee_data.certifications if employee_data else 'Not set' }}</span>
                            </div>
                            <div class="info-row">
                                <span><i class="fas fa-birthday-cake"></i> <strong>DOB:</strong> {{ employee_data.date_of_birth.strftime('%d/%m/%Y') if employee_data and employee_data.date_of_birth else 'Not set' }}</span>
                            </div>
                            <div class="info-row">
                                <span><i class="fas fa-tint"></i> <strong>Blood Group:</strong> {{ employee_data.blood_group if employee_data else 'Not set' }}</span>
                            </div>
                            <div class="info-row">
                                <span><i class="fas fa-envelope"></i> <strong>Email:</strong> {{ user.email }}</span>
                            </div>
                            <div class="info-row">
                                <span><i class="fas fa-phone"></i> <strong>Contact:</strong> {{ employee_data.contact_number if employee_data else 'Not set' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ID Management Section -->
            <section id="id-management-section" class="dashboard-section">
                <h1><i class="fas fa-id-card"></i> ID Management</h1>
                <div class="section-card">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="openCreateIdModal()">
                            <i class="fas fa-plus-circle"></i>
                            <span>Create New ID</span>
                        </button>
                        <button class="action-btn" onclick="openUpdateIdModal()">
                            <i class="fas fa-edit"></i>
                            <span>Update Existing ID</span>
                        </button>
                        <button class="action-btn" onclick="openDeleteIdModal()">
                            <i class="fas fa-trash"></i>
                            <span>Delete ID</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Attendance Section -->
            <section id="attendance-section" class="dashboard-section">
                <h1><i class="fas fa-calendar-check"></i> Attendance</h1>
                <div class="section-card">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="downloadDailyActivityTracker()">
                            <i class="fas fa-download"></i>
                            <span>Download Daily Activity Tracker</span>
                        </button>
                        <button class="action-btn" onclick="openTimeRangeTrackerModal()">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Download Activity Tracker for Specific Time</span>
                        </button>
                        <button class="action-btn" onclick="openAttendanceRecordModal()">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Attendance Record</span>
                        </button>
                        <button class="action-btn" onclick="openPersonalActivityTrackerModal()">
                            <i class="fas fa-user-clock"></i>
                            <span>Personal Activity Tracker</span>
                        </button>
                        <button class="action-btn" onclick="openClientWiseActivityTrackerModal()">
                            <i class="fas fa-building"></i>
                            <span>Client Vise Activity Tracker</span>
                        </button>
                        <button class="action-btn" onclick="openExtraWorkActivityTrackerModal()">
                            <i class="fas fa-plus-circle"></i>
                            <span>Extra Work Activity Approved/Decline</span>
                        </button>
                        <button class="action-btn" onclick="openDownloadExtraWorkModal()">
                            <i class="fas fa-plus-circle"></i>
                            <span>Extra Work Activity Tracker</span>
                        </button>
                        <button class="action-btn" onclick="openAttendanceWithExtraWorkModal()">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Attendance Report with Extra Work</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Employee Performance Section -->
            <section id="employee-performance-section" class="dashboard-section">
                <h1><i class="fas fa-chart-line"></i> Employee Performance</h1>
                <div class="section-card">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="openPunctualityModal()">
                            <i class="fas fa-clock"></i>
                            <span>Punctuality</span>
                        </button>
                        <button class="action-btn" onclick="openBehaviourModal()">
                            <i class="fas fa-user-check"></i>
                            <span>Behaviour</span>
                        </button>
                        <button class="action-btn" onclick="openTeamCoordinationModal()">
                            <i class="fas fa-users"></i>
                            <span>Team Coordination</span>
                        </button>
                        <button class="action-btn" onclick="openCommunicationSkillsModal()">
                            <i class="fas fa-comments"></i>
                            <span>Communication Skills</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Broadcast Mail Section -->
            <section id="broadcast-mail-section" class="dashboard-section">
                <h1><i class="fas fa-envelope"></i> Broadcast Mail</h1>
                <div class="section-card">
                    <h3><i class="fas fa-building"></i> Mail to Client</h3>
                    <div class="sub-section">
                        <div class="action-buttons">
                            <button class="action-btn" onclick="openUpdateClientMailListModal()">
                                <i class="fas fa-edit"></i>
                                <span>Update Client mail list</span>
                            </button>
                            <button class="action-btn" onclick="openSendClientMailModal()">
                                <i class="fas fa-paper-plane"></i>
                                <span>Send mail</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="section-card">
                    <h3><i class="fas fa-users"></i> Mail to Employees</h3>
                    <div class="sub-section">
                        <div class="action-buttons">
                            <button class="action-btn" onclick="openSendEmployeeMailModal()">
                                <i class="fas fa-paper-plane"></i>
                                <span>Send Mail to Employees</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Update Catalog Section -->
            <section id="catalog-section" class="dashboard-section">
                <h1><i class="fas fa-book"></i> Update Catalog</h1>
                <div class="section-card">
                    <div class="action-buttons">
                        <button class="action-btn" onclick="downloadCatalog()">
                            <i class="fas fa-download"></i>
                            <span>Download Catalog</span>
                        </button>
                        <button class="action-btn" onclick="openUploadCatalogModal()">
                            <i class="fas fa-upload"></i>
                            <span>Upload Catalog</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Update Your Work Section -->
            <section id="work-section" class="dashboard-section">
                <h1><i class="fas fa-tasks"></i> Update Your Work</h1>
                <div class="work-cards" style="display: flex; flex-direction: column; align-items: center; gap: 40px;">
                    <!-- First Row: 4 cards -->
                    <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; width: 100%;">
                        <div class="work-card" id="workPlanCard" onclick="openWorkPlanModal()" style="cursor: pointer; width: 180px; height: 180px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box;">
                            <i class="fas fa-calendar-plus"></i>
                            <h3>Submit Today's Work Plan</h3>
                        </div>
                        <div class="work-card" id="updateWorkCard" onclick="openUpdateWorkModal()" style="cursor: pointer; width: 180px; height: 180px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box;">
                            <i class="fas fa-edit"></i>
                            <h3>Update Today's Work</h3>
                        </div>
                        <div class="work-card" id="sprintPlanCard" onclick="openSprintPlanModal()" style="cursor: pointer; width: 180px; height: 180px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box;">
                            <i class="fas fa-calendar-week"></i>
                            <h3>Submit Sprint Plan</h3>
                        </div>
                        <div class="work-card" id="lastWeekSprintCard" onclick="openLastWeekSprintModal()" style="cursor: pointer; width: 180px; height: 180px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box;">
                            <i class="fas fa-calendar-check"></i>
                            <h3>Submit Last Week Sprint</h3>
                        </div>
                    </div>
                    
                    <!-- Second Row: 3 cards -->
                    <div style="display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; width: 100%;">
                        <div class="work-card" id="extraWorkCard" onclick="openExtraWorkModal()" style="cursor: pointer; width: 180px; height: 180px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box;">
                            <i class="fas fa-plus-circle"></i>
                            <h3>Extra Work</h3>
                        </div>
                        <div class="work-card" id="leaveApprovalCard" onclick="openLeaveApprovalModal()" style="cursor: pointer; width: 180px; height: 180px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box;">
                            <i class="fas fa-umbrella-beach"></i>
                            <h3>Leave Approval Request</h3>
                        </div>
                        <div class="work-card" id="complaintCard" onclick="openComplaintModal()" style="cursor: pointer; width: 180px; height: 180px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Complaint About Team</h3>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals will be added here -->
    <!-- ID Management Modals -->
    <div id="createIdModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Create New ID</h3>
                <span class="close-modal" onclick="closeCreateIdModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="createIdForm" action="{{ url_for('create_user') }}" method="POST" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>Employee Name*</label>
                        <input type="text" name="employee_name" required>
                    </div>
                    <div class="form-group">
                        <label>Username*</label>
                        <input type="text" name="username" required>
                    </div>
                    <div class="form-group">
                        <label>Password*</label>
                        <input type="password" name="password" required autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label>Designation*</label>
                        <select name="designation" required>
                            <option value="">Select Designation</option>
                            <option value="Process Associate">Process Associate</option>
                            <option value="Senior Process Associate">Senior Process Associate</option>
                            <option value="Associate">Associate</option>
                            <option value="Security Analyst">Security Analyst</option>
                            <option value="Security Researcher">Security Researcher</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Department*</label>
                        <select name="department" required>
                            <option value="">Select Department</option>
                            <option value="VAPT">VAPT Department</option>
                            <option value="Audit">Audit Department</option>
                            <option value="GRC">GRC Department</option>
                            <option value="HR">HR Department</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Experience* (e.g., 0.5, 1, 1.5, 2, 2.5...)</label>
                        <input type="number" name="experience" step="0.5" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Education*</label>
                        <input type="text" name="education" required>
                    </div>
                    <div class="form-group">
                        <label>Certification*</label>
                        <input type="text" name="certifications" required>
                    </div>
                    <div class="form-group">
                        <label>Date of Birth*</label>
                        <input type="date" name="date_of_birth" required>
                    </div>
                    <div class="form-group">
                        <label>Blood Group*</label>
                        <select name="blood_group" required>
                            <option value="">Select Blood Group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Email*</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Contact*</label>
                        <input type="text" name="contact" required>
                    </div>
                    <div class="form-group">
                        <label>Browser Fingerprint*</label>
                        <input type="text" name="browser_fingerprint" required>
                    </div>
                    <div class="form-group">
                        <label>Employee Photo*</label>
                        <input type="file" name="photo" accept="image/*" required>
                    </div>
                    
                    <!-- OTP Authentication Section -->
                    <hr style="margin: 20px 0; border: none; border-top: 2px solid #ddd;">
                    <div class="form-group">
                        <h3 style="margin-bottom: 15px; color: #e74c3c;">Authorization Required</h3>
                        <p style="color: #666; margin-bottom: 15px;">An OTP will be sent to the authorized email address. Please verify the OTP to create the ID.</p>
                        
                        <div id="otpRequestSection">
                            <button type="button" id="requestOtpBtn" class="submit-btn" style="background-color: #3498db; margin-bottom: 15px;">Request OTP</button>
                            <p id="otpRequestStatus" style="color: #27ae60; display: none; margin-top: 10px;"></p>
                        </div>
                        
                        <div id="otpVerificationSection" style="display: none;">
                            <div class="form-group">
                                <label for="otpInput">Enter OTP*</label>
                                <input type="text" id="otpInput" name="otp" placeholder="Enter 8-character OTP" maxlength="8" style="text-transform: uppercase; letter-spacing: 2px; font-size: 16px; font-weight: bold;">
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    OTP is valid for 3 minutes. 
                                    <span id="otpTimer" style="color: #e74c3c; font-weight: bold; font-size: 14px;"></span>
                                </small>
                            </div>
                            <button type="button" id="verifyOtpBtn" class="submit-btn" style="background-color: #27ae60; margin-bottom: 15px;">Verify OTP</button>
                            <p id="otpVerifyStatus" style="margin-top: 10px;"></p>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="createIdSubmitBtn" disabled style="opacity: 0.6; cursor: not-allowed;">Create ID</button>
                        <button type="button" class="cancel-btn" onclick="closeCreateIdModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="updateIdModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Update Existing ID</h3>
                <span class="close-modal" onclick="closeUpdateIdModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Step 1: Select Employee -->
                <div id="selectEmployeeStep">
                    <div class="form-group">
                        <label>Select Employee*</label>
                        <select id="employeeSelect" required style="width: 100%; padding: 10px; font-size: 1rem;">
                            <option value="">Loading employees...</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="submit-btn" onclick="loadEmployeeDetails()">Load Details</button>
                        <button type="button" class="cancel-btn" onclick="closeUpdateIdModal()">Cancel</button>
                    </div>
                </div>

                <!-- Step 2: Edit Employee Details -->
                <div id="editEmployeeStep" style="display: none;">
                    <form id="updateIdForm">
                        <input type="hidden" id="update_user_id" name="user_id">
                        
                        <div class="form-group">
                            <label>Employee Name*</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="update_employee_name" name="employee_name" required style="flex: 1;">
                                <button type="button" class="update-field-btn" onclick="updateField('employee_name')" title="Update Employee Name">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Username*</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="update_username" name="username" required style="flex: 1;">
                                <button type="button" class="update-field-btn" onclick="updateField('username')" title="Update Username">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Password*</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="password" id="update_password" name="password" required style="flex: 1;" autocomplete="new-password">
                                <button type="button" class="update-field-btn" onclick="updateField('password')" title="Update Password">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Designation*</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="update_designation" name="designation" required style="flex: 1;">
                                    <option value="">Select Designation</option>
                                    <option value="Process Associate">Process Associate</option>
                                    <option value="Senior Process Associate">Senior Process Associate</option>
                                    <option value="Associate">Associate</option>
                                    <option value="Security Analyst">Security Analyst</option>
                                    <option value="Security Researcher">Security Researcher</option>
                                </select>
                                <button type="button" class="update-field-btn" onclick="updateField('designation')" title="Update Designation">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Department*</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="update_department" name="department" required style="flex: 1;">
                                    <option value="">Select Department</option>
                                    <option value="VAPT">VAPT Department</option>
                                    <option value="Audit">Audit Department</option>
                                    <option value="GRC">GRC Department</option>
                                    <option value="HR">HR Department</option>
                                </select>
                                <button type="button" class="update-field-btn" onclick="updateField('department')" title="Update Department">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Experience* (e.g., 0.5, 1, 1.5, 2, 2.5...)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="update_experience" name="experience" step="0.5" min="0" required style="flex: 1;">
                                <button type="button" class="update-field-btn" onclick="updateField('experience')" title="Update Experience">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Education*</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="update_education" name="education" required style="flex: 1;">
                                <button type="button" class="update-field-btn" onclick="updateField('education')" title="Update Education">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Certification*</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="update_certifications" name="certifications" required style="flex: 1;">
                                <button type="button" class="update-field-btn" onclick="updateField('certifications')" title="Update Certification">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Date of Birth*</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" id="update_date_of_birth" name="date_of_birth" required style="flex: 1;">
                                <button type="button" class="update-field-btn" onclick="updateField('date_of_birth')" title="Update Date of Birth">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Blood Group*</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="update_blood_group" name="blood_group" required style="flex: 1;">
                                    <option value="">Select Blood Group</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                </select>
                                <button type="button" class="update-field-btn" onclick="updateField('blood_group')" title="Update Blood Group">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Email*</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="email" id="update_email" name="email" required style="flex: 1;">
                                <button type="button" class="update-field-btn" onclick="updateField('email')" title="Update Email">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Contact*</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="update_contact" name="contact" required style="flex: 1;">
                                <button type="button" class="update-field-btn" onclick="updateField('contact')" title="Update Contact">Update</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Browser Fingerprint*</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="update_browser_fingerprint" name="browser_fingerprint" required style="flex: 1;">
                                <button type="button" class="update-field-btn" onclick="updateField('browser_fingerprint')" title="Update Browser Fingerprint">Update</button>
                            </div>
                        </div>
                        
                        <!-- OTP Authentication Section -->
                        <hr style="margin: 20px 0; border: none; border-top: 2px solid #ddd;">
                        <div class="form-group">
                            <h3 style="margin-bottom: 15px; color: #e74c3c;">Authorization Required</h3>
                            <p style="color: #666; margin-bottom: 15px;">An OTP will be sent to the authorized email address. Please verify the OTP to update employee details.</p>
                            
                            <div id="updateOtpRequestSection">
                                <button type="button" id="updateRequestOtpBtn" class="submit-btn" style="background-color: #3498db; margin-bottom: 15px;">Request OTP</button>
                                <p id="updateOtpRequestStatus" style="color: #27ae60; display: none; margin-top: 10px;"></p>
                            </div>
                            
                            <div id="updateOtpVerificationSection" style="display: none;">
                                <div class="form-group">
                                    <label for="updateOtpInput">Enter OTP*</label>
                                    <input type="text" id="updateOtpInput" name="otp" placeholder="Enter 8-character OTP" maxlength="8" style="text-transform: uppercase; letter-spacing: 2px; font-size: 16px; font-weight: bold;">
                                    <small style="color: #666; display: block; margin-top: 5px;">
                                        OTP is valid for 3 minutes. 
                                        <span id="updateOtpTimer" style="color: #e74c3c; font-weight: bold; font-size: 14px;"></span>
                                    </small>
                                </div>
                                <button type="button" id="updateVerifyOtpBtn" class="submit-btn" style="background-color: #27ae60; margin-bottom: 15px;">Verify OTP</button>
                                <p id="updateOtpVerifyStatus" style="margin-top: 10px;"></p>
                            </div>
                        </div>

                        <div class="form-actions" style="margin-top: 20px;">
                            <button type="button" class="submit-btn" id="updateAllFieldsBtn" onclick="updateAllFields()" disabled style="opacity: 0.6; cursor: not-allowed;">Submit All Changes</button>
                            <button type="button" class="cancel-btn" onclick="closeUpdateIdModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="deleteIdModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Delete ID</h3>
                <span class="close-modal" onclick="closeDeleteIdModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #c0392b; font-weight: 500;">
                    Selecting an employee and clicking "Delete ID" will permanently remove their login credentials and employee records.
                </p>
                <div class="form-group">
                    <label>Select Employee*</label>
                    <select id="deleteEmployeeSelect" required style="width: 100%; padding: 10px; font-size: 1rem;">
                        <option value="">Loading employees...</option>
                    </select>
                </div>
                
                <!-- OTP Authentication Section -->
                <hr style="margin: 20px 0; border: none; border-top: 2px solid #ddd;">
                <div class="form-group">
                    <h3 style="margin-bottom: 15px; color: #e74c3c;">Authorization Required</h3>
                    <p style="color: #666; margin-bottom: 15px;">An OTP will be sent to the authorized email address. Please verify the OTP to delete employee ID.</p>
                    
                    <div id="deleteOtpRequestSection">
                        <button type="button" id="deleteRequestOtpBtn" class="submit-btn" style="background-color: #3498db; margin-bottom: 15px;">Request OTP</button>
                        <p id="deleteOtpRequestStatus" style="color: #27ae60; display: none; margin-top: 10px;"></p>
                    </div>
                    
                    <div id="deleteOtpVerificationSection" style="display: none;">
                        <div class="form-group">
                            <label for="deleteOtpInput">Enter OTP*</label>
                            <input type="text" id="deleteOtpInput" name="otp" placeholder="Enter 8-character OTP" maxlength="8" style="text-transform: uppercase; letter-spacing: 2px; font-size: 16px; font-weight: bold;">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                OTP is valid for 3 minutes. 
                                <span id="deleteOtpTimer" style="color: #e74c3c; font-weight: bold; font-size: 14px;"></span>
                            </small>
                        </div>
                        <button type="button" id="deleteVerifyOtpBtn" class="submit-btn" style="background-color: #27ae60; margin-bottom: 15px;">Verify OTP</button>
                        <p id="deleteOtpVerifyStatus" style="margin-top: 10px;"></p>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="submit-btn" id="deleteIdBtn" style="background: #e74c3c; opacity: 0.6; cursor: not-allowed;" onclick="deleteSelectedUser()" disabled>Delete ID</button>
                    <button type="button" class="cancel-btn" onclick="closeDeleteIdModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="changeRoleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Change Role</h3>
                <span class="close-modal" onclick="closeModal('changeRoleModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="changeRoleForm">
                    <div class="form-group">
                        <label>Select Employee*</label>
                        <select name="employee_id" required>
                            <option value="">Select Employee</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>New Role*</label>
                        <select name="new_role" required>
                            <option value="">Select Role</option>
                            <option value="Employee">Employee</option>
                            <option value="Manager">Manager</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Change Role</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('changeRoleModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Attendance Modals -->
    <div id="dailyTrackerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Download Daily Activity Tracker</h3>
                <span class="close-modal" onclick="closeModal('dailyTrackerModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="dailyTrackerForm" method="POST" action="{{ url_for('hr_dashboard_bp.download_daily_activity_tracker') }}">
                    <div class="form-group">
                        <label>Select File*</label>
                        <select name="tracker_date" id="trackerDateSelect" required style="width: 100%; padding: 10px; font-size: 1rem;">
                            <option value="">Loading available files...</option>
                        </select>
                        <input type="hidden" name="selected_filename" id="selectedFilename" value="">
                        <small id="trackerDateInfo" style="display: block; margin-top: 5px; color: #666;">Loading available files...</small>
                        <div id="trackerDateError" style="display: none; color: #e74c3c; margin-top: 5px; font-size: 0.9rem;"></div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="trackerDownloadBtn" disabled>Download</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('dailyTrackerModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="timeRangeTrackerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Download Activity Tracker for Specific Time</h3>
                <span class="close-modal" onclick="closeModal('timeRangeTrackerModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="timeRangeTrackerForm" method="POST" action="{{ url_for('hr_dashboard_bp.download_time_range_tracker') }}">
                    <div class="form-group">
                        <label>Start Date*</label>
                        <input type="date" name="start_date" id="startDateInput" required min="2025-10-01" style="width: 100%; padding: 10px; font-size: 1rem;">
                    </div>
                    <div class="form-group">
                        <label>End Date*</label>
                        <input type="date" name="end_date" id="endDateInput" required min="2025-10-01" style="width: 100%; padding: 10px; font-size: 1rem;">
                    </div>
                    <div id="timeRangeError" style="display: none; color: #e74c3c; margin-top: 5px; font-size: 0.9rem;"></div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="timeRangeDownloadBtn">Download</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('timeRangeTrackerModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="attendanceRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Attendance Record</h3>
                <span class="close-modal" onclick="closeModal('attendanceRecordModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="attendanceRecordForm" method="POST" action="{{ url_for('hr_dashboard_bp.generate_attendance_record') }}">
                    <div class="form-group">
                        <label>Month*</label>
                        <select name="month" required style="width: 100%; padding: 10px; font-size: 1rem;">
                            <option value="">Select Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year*</label>
                        <input type="number" name="year" min="2020" max="2030" value="2025" required style="width: 100%; padding: 10px; font-size: 1rem;">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Generate Report</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('attendanceRecordModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="personalActivityTrackerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Personal Activity Tracker</h3>
                <span class="close-modal" onclick="closeModal('personalActivityTrackerModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="personalActivityTrackerForm" method="POST" action="{{ url_for('hr_dashboard_bp.generate_personal_activity_tracker') }}">
                    <div class="form-group">
                        <label>Employee Name*</label>
                        <select name="employee_name" id="employeeNameSelect" required style="width: 100%; padding: 10px; font-size: 1rem;">
                            <option value="">Loading employees...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Month*</label>
                        <select name="month" required style="width: 100%; padding: 10px; font-size: 1rem;">
                            <option value="">Select Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year*</label>
                        <input type="number" name="year" min="2020" max="2030" value="2025" required style="width: 100%; padding: 10px; font-size: 1rem;">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Generate Report</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('personalActivityTrackerModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="clientWiseActivityTrackerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Client Wise Activity Tracker</h3>
                <span class="close-modal" onclick="closeModal('clientWiseActivityTrackerModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="clientWiseActivityTrackerForm" method="POST" action="{{ url_for('hr_dashboard_bp.generate_client_wise_activity_tracker') }}">
                    <div class="form-group">
                        <label>Month*</label>
                        <select name="month" required style="width: 100%; padding: 10px; font-size: 1rem;">
                            <option value="">Select Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year*</label>
                        <input type="number" name="year" min="2020" max="2030" value="2025" required style="width: 100%; padding: 10px; font-size: 1rem;">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Generate Report</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('clientWiseActivityTrackerModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="extraWorkActivityTrackerModal" class="modal" style="max-width: 90%; width: 1200px;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Extra Work Activity Tracker</h3>
                <span class="close-modal" onclick="closeModal('extraWorkActivityTrackerModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="extraWorkLoading" style="text-align: center; padding: 20px;">
                    <p>Loading extra work entries...</p>
                </div>
                <div id="extraWorkContent" style="display: none;">
                    <div id="extraWorkMessage" style="margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;"></div>
                    <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                        <table id="extraWorkTable" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background-color: #366092; color: white; position: sticky; top: 0;">
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Sr. No</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Employee Name</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Date</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Task</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Time</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Client</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Source File</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="extraWorkTableBody">
                                <!-- Entries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 15px; text-align: right;">
                        <button type="button" class="cancel-btn" onclick="closeModal('extraWorkActivityTrackerModal')">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="downloadExtraWorkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Download Extra Work Activity Tracker</h3>
                <span class="close-modal" onclick="closeModal('downloadExtraWorkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="downloadExtraWorkForm" method="POST" action="{{ url_for('hr_dashboard_bp.download_approved_extra_work') }}">
                    <div class="form-group">
                        <label>Month*</label>
                        <select name="month" required style="width: 100%; padding: 10px; font-size: 1rem;">
                            <option value="">Select Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year*</label>
                        <input type="number" name="year" min="2020" max="2030" value="2025" required style="width: 100%; padding: 10px; font-size: 1rem;">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Download</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('downloadExtraWorkModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="attendanceWithExtraWorkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Attendance Report with Extra Work</h3>
                <span class="close-modal" onclick="closeModal('attendanceWithExtraWorkModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="attendanceWithExtraWorkForm" method="POST" action="{{ url_for('hr_dashboard_bp.generate_attendance_with_extra_work') }}">
                    <div class="form-group">
                        <label>Month*</label>
                        <select name="month" required style="width: 100%; padding: 10px; font-size: 1rem;">
                            <option value="">Select Month</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Year*</label>
                        <input type="number" name="year" min="2020" max="2030" value="2025" required style="width: 100%; padding: 10px; font-size: 1rem;">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Generate Report</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('attendanceWithExtraWorkModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Broadcast Mail Modals -->
    <div id="updateClientMailListModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Update Client Mail List</h3>
                <span class="close-modal" onclick="closeModal('updateClientMailListModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <button type="button" class="submit-btn" onclick="showAddClientMailForm()" style="margin-bottom: 15px;">
                        <i class="fas fa-plus"></i> Add New Email
                    </button>
                    <div id="addClientMailForm" style="display: none; padding: 15px; background-color: #f9f9f9; border-radius: 5px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Email Address*</label>
                            <input type="email" id="newClientEmail" placeholder="Enter client email address" required style="width: 100%; padding: 10px; font-size: 1rem;">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="submit-btn" onclick="addClientMail()">Add</button>
                            <button type="button" class="cancel-btn" onclick="hideAddClientMailForm()">Cancel</button>
                        </div>
                    </div>
                </div>
                <div id="clientMailLoading" style="text-align: center; padding: 20px;">
                    <p>Loading client mail list...</p>
                </div>
                <div id="clientMailList" style="display: none;">
                    <h4 style="margin-bottom: 15px;">Client Mail Addresses</h4>
                    <div id="clientMailListContent" style="max-height: 400px; overflow-y: auto;">
                        <!-- Client mail list will be populated here -->
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button type="button" class="cancel-btn" onclick="closeModal('updateClientMailListModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sendClientMailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Send Mail to All Clients</h3>
                <span class="close-modal" onclick="closeModal('sendClientMailModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="sendClientMailForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>Subject*</label>
                        <input type="text" name="subject" id="clientMailSubject" required style="width: 100%; padding: 10px; font-size: 1rem;">
                    </div>
                    <div class="form-group">
                        <label>Content*</label>
                        <div id="clientMailContentEditor" contenteditable="true" style="min-height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; font-size: 1rem; overflow-y: auto;" required></div>
                        <div style="margin-top: 5px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button type="button" onclick="formatText('bold')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Bold"><strong>B</strong></button>
                            <button type="button" onclick="formatText('italic')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Italic"><em>I</em></button>
                            <button type="button" onclick="formatText('underline')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Underline"><u>U</u></button>
                            <button type="button" onclick="formatText('justifyLeft')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Align Left"></button>
                            <button type="button" onclick="formatText('justifyCenter')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Align Center"></button>
                            <button type="button" onclick="formatText('justifyRight')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Align Right"></button>
                            <button type="button" onclick="formatText('insertUnorderedList')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Bullet List"> List</button>
                            <button type="button" onclick="formatText('insertOrderedList')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Numbered List">1. List</button>
                        </div>
                        <input type="hidden" name="content" id="clientMailContentHidden">
                    </div>
                    <div class="form-group">
                        <label>Attachments (Multiple files allowed)</label>
                        <input type="file" name="attachments" id="clientMailAttachments" multiple style="width: 100%; padding: 10px; font-size: 1rem;">
                        <small style="color: #666;">You can select multiple files to attach</small>
                        <div id="attachmentPreview" style="margin-top: 10px;"></div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="sendClientMailBtn">Send Mail to All Clients</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('sendClientMailModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="sendEmployeeMailModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Send Mail to Employees</h3>
                <span class="close-modal" onclick="closeModal('sendEmployeeMailModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="sendEmployeeMailForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label>Subject*</label>
                        <input type="text" name="subject" id="employeeMailSubject" required style="width: 100%; padding: 10px; font-size: 1rem;">
                    </div>
                    <div class="form-group">
                        <label>Content*</label>
                        <div id="employeeMailContentEditor" contenteditable="true" style="min-height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; font-size: 1rem; overflow-y: auto;" required></div>
                        <div style="margin-top: 5px; display: flex; gap: 5px; flex-wrap: wrap;">
                            <button type="button" onclick="formatEmployeeText('bold')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Bold"><strong>B</strong></button>
                            <button type="button" onclick="formatEmployeeText('italic')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Italic"><em>I</em></button>
                            <button type="button" onclick="formatEmployeeText('underline')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Underline"><u>U</u></button>
                            <button type="button" onclick="formatEmployeeText('justifyLeft')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Align Left"></button>
                            <button type="button" onclick="formatEmployeeText('justifyCenter')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Align Center"></button>
                            <button type="button" onclick="formatEmployeeText('justifyRight')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Align Right"></button>
                            <button type="button" onclick="formatEmployeeText('insertUnorderedList')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Bullet List"> List</button>
                            <button type="button" onclick="formatEmployeeText('insertOrderedList')" style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer;" title="Numbered List">1. List</button>
                        </div>
                        <input type="hidden" name="content" id="employeeMailContentHidden">
                    </div>
                    <div class="form-group">
                        <label>Attachments (Multiple files allowed)</label>
                        <input type="file" name="attachments" id="employeeMailAttachments" multiple style="width: 100%; padding: 10px; font-size: 1rem;">
                        <small style="color: #666;">You can select multiple files to attach</small>
                        <div id="employeeAttachmentPreview" style="margin-top: 10px;"></div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="sendEmployeeMailBtn">Send Mail to Employees</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('sendEmployeeMailModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="customBroadcastMailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Custom Broad Cast Mail</h3>
                <span class="close-modal" onclick="closeModal('customBroadcastMailModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="customBroadcastMailForm">
                    <div class="form-group">
                        <label>Recipients*</label>
                        <textarea name="recipients" rows="5" placeholder="Enter email addresses separated by commas" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Subject*</label>
                        <input type="text" name="subject" required>
                    </div>
                    <div class="form-group">
                        <label>Message*</label>
                        <textarea name="message" rows="10" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Send Broadcast Mail</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('customBroadcastMailModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Download Catalog Modal -->
    <div id="downloadCatalogModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Download Catalog</h3>
                <span class="close-modal" onclick="closeModal('downloadCatalogModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button class="action-btn" onclick="downloadCatalogFile('infrastructure')" style="width: 100%; padding: 15px; text-align: left; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-server"></i>
                        <span>Infrastructure VAPT Catalog</span>
                    </button>
                    <button class="action-btn" onclick="downloadCatalogFile('public_ip')" style="width: 100%; padding: 15px; text-align: left; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-network-wired"></i>
                        <span>Public IP VAPT Catalog</span>
                    </button>
                    <button class="action-btn" onclick="downloadCatalogFile('website')" style="width: 100%; padding: 15px; text-align: left; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-globe"></i>
                        <span>Website VAPT Catalog</span>
                    </button>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="cancel-btn" onclick="closeModal('downloadCatalogModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Catalog Modal -->
    <div id="uploadCatalogModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Upload Catalog</h3>
                <span class="close-modal" onclick="closeUploadCatalogModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Step 1: Select Catalog Type -->
                <div id="uploadCatalogTypeSelection">
                    <p style="margin-bottom: 20px; color: #666;">Select the catalog type you want to upload:</p>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button class="action-btn" onclick="selectCatalogType('infrastructure')" style="width: 100%; padding: 15px; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-server"></i>
                            <span>Infrastructure VAPT Catalog</span>
                        </button>
                        <button class="action-btn" onclick="selectCatalogType('public_ip')" style="width: 100%; padding: 15px; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-network-wired"></i>
                            <span>Public IP VAPT Catalog</span>
                        </button>
                        <button class="action-btn" onclick="selectCatalogType('website')" style="width: 100%; padding: 15px; text-align: left; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-globe"></i>
                            <span>Website VAPT Catalog</span>
                        </button>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button type="button" class="cancel-btn" onclick="closeUploadCatalogModal()">Close</button>
                    </div>
                </div>
                
                <!-- Step 2: Upload File -->
                <div id="uploadCatalogFileForm" style="display: none;">
                    <form id="uploadCatalogForm" enctype="multipart/form-data">
                        <div class="form-group">
                            <label id="uploadCatalogTypeLabel">Select Catalog File*</label>
                            <input type="file" name="catalog_file" id="catalogFileInput" accept=".xlsx,.xls" required style="width: 100%; padding: 10px; font-size: 1rem;">
                            <small style="color: #666;">Please upload an Excel file (.xlsx or .xls). The file will be renamed automatically.</small>
                            <input type="hidden" name="catalog_type" id="selectedCatalogType">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="submit-btn" id="uploadCatalogBtn">Upload</button>
                            <button type="button" class="cancel-btn" onclick="backToCatalogTypeSelection()">Back</button>
                            <button type="button" class="cancel-btn" onclick="closeUploadCatalogModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Employee Performance Modals -->
    <!-- Punctuality Modal -->
    <div id="punctualityModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Punctuality - Employee Performance</h3>
                <span class="close-modal" onclick="closeModal('punctualityModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="punctualityForm">
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
                        <p style="margin: 0; color: #666;"><strong>Note:</strong> Enter ratings from 1-10 for each employee. Data will be saved for the current month.</p>
                    </div>
                    <div id="punctualityEmployeesList" style="max-height: 500px; overflow-y: auto;">
                        <!-- Employee inputs will be populated here -->
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="punctualitySubmitBtn">Save Punctuality Ratings</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('punctualityModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Behaviour Modal -->
    <div id="behaviourModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Behaviour - Employee Performance</h3>
                <span class="close-modal" onclick="closeModal('behaviourModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="behaviourForm">
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
                        <p style="margin: 0; color: #666;"><strong>Note:</strong> Enter ratings from 1-10 for each employee. Data will be saved for the current month.</p>
                    </div>
                    <div id="behaviourEmployeesList" style="max-height: 500px; overflow-y: auto;">
                        <!-- Employee inputs will be populated here -->
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="behaviourSubmitBtn">Save Behaviour Ratings</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('behaviourModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Team Coordination Modal -->
    <div id="teamCoordinationModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Team Coordination - Employee Performance</h3>
                <span class="close-modal" onclick="closeModal('teamCoordinationModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="teamCoordinationForm">
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
                        <p style="margin: 0; color: #666;"><strong>Note:</strong> Enter ratings from 1-10 for each employee. Data will be saved for the current month.</p>
                    </div>
                    <div id="teamCoordinationEmployeesList" style="max-height: 500px; overflow-y: auto;">
                        <!-- Employee inputs will be populated here -->
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="teamCoordinationSubmitBtn">Save Team Coordination Ratings</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('teamCoordinationModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Communication Skills Modal -->
    <div id="communicationSkillsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Communication Skills - Employee Performance</h3>
                <span class="close-modal" onclick="closeModal('communicationSkillsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="communicationSkillsForm">
                    <div style="margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 5px;">
                        <p style="margin: 0; color: #666;"><strong>Note:</strong> Enter ratings from 1-10 for each employee. Data will be saved for the current month.</p>
                    </div>
                    <div id="communicationSkillsEmployeesList" style="max-height: 500px; overflow-y: auto;">
                        <!-- Employee inputs will be populated here -->
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="communicationSkillsSubmitBtn">Save Communication Skills Ratings</button>
                        <button type="button" class="cancel-btn" onclick="closeModal('communicationSkillsModal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Work Plan Modal -->
    <div id="workPlanModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Submit Today's Work Plan</h3>
                <span class="close-modal" onclick="closeWorkPlanModal()">&times;</span>
            </div>
            <div class="modal-body scrollable-content">
                <form id="workPlanForm" onsubmit="handleWorkPlanSubmit(event)">
                    <!-- Hidden field for status check -->
                    <input type="hidden" id="workPlanEmployeeNameForCheck" value="{{ user.employee_name if user else '' }}">
                    
                    <!-- Read-only fields -->
                    <div class="form-group">
                        <label for="workPlanDate">Date</label>
                        <input type="date" id="workPlanDate" name="date" readonly style="background-color: #f5f5f5;">
                    </div>

                    <div class="form-group">
                        <label for="workPlanEmployeeName">Employee Name</label>
                        <input type="text" id="workPlanEmployeeName" name="employeeName" readonly style="background-color: #f5f5f5;" value="{{ user.employee_name if user else '' }}">
                    </div>

                    <div class="form-group">
                        <label for="workPlanEmployeeTeam">Employee Team</label>
                        <input type="text" id="workPlanEmployeeTeam" name="employeeTeam" readonly style="background-color: #f5f5f5;" value="{{ user.department if user else '' }}">
                    </div>

                    <!-- Task Section -->
                    <hr style="margin: 20px 0; border: none; border-top: 2px solid #ddd;">
                    <div class="form-group">
                        <h3 style="margin-bottom: 15px;">Task Details</h3>
                        
                        <div id="workPlanTaskContainer">
                            <div class="task-entry" data-task-index="0">
                                <div class="form-group">
                                    <label for="workPlanTask_0">Task*</label>
                                    <input type="text" id="workPlanTask_0" name="task[]" placeholder="Enter task name" required>
                                </div>

                                <div class="form-group">
                                    <label for="workPlanTaskDescription_0">Task Description*</label>
                                    <textarea id="workPlanTaskDescription_0" name="taskDescription[]" rows="2" placeholder="Enter task description" required></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="workPlanClientName_0">Client Name*</label>
                                    <input type="text" id="workPlanClientName_0" name="clientName[]" placeholder="Enter client name" required>
                                </div>

                                <div class="form-group">
                                    <label for="workPlanTime_0">Time Taken (in Hours)*</label>
                                    <input type="number" id="workPlanTime_0" name="time[]" step="0.01" min="0" placeholder="e.g., 1.25, 2.5" required>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="add-member-btn" id="addWorkPlanTaskBtn" style="margin-top: 15px;">+ Add New Task</button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeWorkPlanModal()">Cancel</button>
                        <button type="submit" class="submit-btn">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Update Work Modal -->
    <div id="updateWorkModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Update Today's Work</h3>
                <span class="close-modal" onclick="closeUpdateWorkModal()">&times;</span>
            </div>
            <div class="modal-body scrollable-content">
                <form id="updateWorkForm" onsubmit="handleUpdateWorkSubmit(event)">
                    <!-- Hidden field for status check -->
                    <input type="hidden" id="updateWorkEmployeeNameForCheck" value="{{ user.employee_name if user else '' }}">
                    
                    <!-- Read-only fields -->
                    <div class="form-group">
                        <label for="updateWorkDate">Date</label>
                        <input type="date" id="updateWorkDate" name="date" readonly style="background-color: #f5f5f5;">
                    </div>

                    <div class="form-group">
                        <label for="updateWorkEmployeeName">Employee Name</label>
                        <input type="text" id="updateWorkEmployeeName" name="employeeName" readonly style="background-color: #f5f5f5;" value="{{ user.employee_name if user else '' }}">
                    </div>

                    <div class="form-group">
                        <label for="updateWorkEmployeeTeam">Employee Team</label>
                        <input type="text" id="updateWorkEmployeeTeam" name="employeeTeam" readonly style="background-color: #f5f5f5;" value="{{ user.department if user else '' }}">
                    </div>

                    <!-- Task Section -->
                    <hr style="margin: 20px 0; border: none; border-top: 2px solid #ddd;">
                    <div class="form-group">
                        <h3 style="margin-bottom: 15px;">Task Details</h3>
                        
                        <div id="updateWorkTaskContainer">
                            <div class="task-entry" data-task-index="0">
                                <div class="form-group">
                                    <label for="updateWorkTask_0">Task*</label>
                                    <input type="text" id="updateWorkTask_0" name="task[]" placeholder="Enter task name" required>
                                </div>

                                <div class="form-group">
                                    <label for="updateWorkClientName_0">Client Name*</label>
                                    <input type="text" id="updateWorkClientName_0" name="clientName[]" placeholder="Enter client name" required>
                                </div>

                                <div class="form-group">
                                    <label for="updateWorkTime_0">Time Taken (in Hours)*</label>
                                    <input type="number" id="updateWorkTime_0" name="time[]" step="0.01" min="0" placeholder="e.g., 1.25, 2.5" required>
                                </div>

                                <div class="form-group">
                                    <label for="updateWorkStatus_0">Status*</label>
                                    <select id="updateWorkStatus_0" name="status[]" required>
                                        <option value="">Select Status</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Pending">Pending</option>
                                        <option value="In Progress">In Progress</option>
                                        <option value="Remove">Remove</option>
                                        <option value="Take over">Take over</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="updateWorkDescription_0">Description*</label>
                                    <textarea id="updateWorkDescription_0" name="description[]" rows="2" placeholder="Enter description" required></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="add-member-btn" id="addUpdateWorkTaskBtn" style="margin-top: 15px;">+ Add New Task</button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeUpdateWorkModal()">Cancel</button>
                        <button type="submit" class="submit-btn">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sprint Plan Modal -->
    <div id="sprintPlanModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Submit Sprint Plan</h3>
                <span class="close-modal" onclick="closeSprintPlanModal()">&times;</span>
            </div>
            <div class="modal-body scrollable-content">
                <form id="sprintPlanForm" onsubmit="handleSprintPlanSubmit(event)">
                    <!-- Hidden field for status check -->
                    <input type="hidden" id="sprintPlanEmployeeNameForCheck" value="{{ user.employee_name if user else '' }}">
                    
                    <!-- Read-only fields -->
                    <div class="form-group">
                        <label for="sprintPlanEmployeeName">Employee Name</label>
                        <input type="text" id="sprintPlanEmployeeName" name="employeeName" readonly style="background-color: #f5f5f5;" value="{{ user.employee_name if user else '' }}">
                    </div>

                    <div class="form-group">
                        <label for="sprintPlanEmployeeTeam">Employee Team</label>
                        <input type="text" id="sprintPlanEmployeeTeam" name="employeeTeam" readonly style="background-color: #f5f5f5;" value="{{ user.department if user else '' }}">
                    </div>

                    <!-- Day Section -->
                    <hr style="margin: 20px 0; border: none; border-top: 2px solid #ddd;">
                    <div class="form-group">
                        <h3 style="margin-bottom: 15px;">Sprint Plan for Next 6 Days</h3>
                        
                        <div id="sprintPlanDayContainer">
                            <div class="day-entry" data-day-index="0">
                                <div class="form-group">
                                    <label>Date*</label>
                                    <input type="date" class="sprint-date-input" name="dates[]" required>
                                </div>
                                
                                <div class="form-group">
                                    <h4 style="margin-bottom: 10px;">Tasks</h4>
                                    <div id="sprintDay0TaskContainer" class="task-container">
                                        <div class="task-entry" data-task-index="0">
                                            <div class="form-group">
                                                <label>Task*</label>
                                                <input type="text" name="tasks[0][]" placeholder="Enter task" required>
                                            </div>
                                            <div class="form-group">
                                                <label>Client Name*</label>
                                                <input type="text" name="clientNames[0][]" placeholder="Enter client name" required>
                                            </div>
                                            <div class="form-group">
                                                <label>Time (Hours)*</label>
                                                <input type="number" name="times[0][]" step="0.01" min="0" placeholder="e.g., 1.25" required>
                                            </div>
                                            <button type="button" onclick="removeSprintTask(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">Remove</button>
                                        </div>
                                    </div>
                                    <button type="button" class="add-member-btn add-sprint-task-btn" data-day="0" style="margin-top: 10px;">+ Add New Task</button>
                                </div>
                                
                                <button type="button" onclick="removeSprintDay(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 10px; margin-top: 15px; cursor: pointer; width: 100%;">Remove This Day</button>
                            </div>
                        </div>
                        
                        <button type="button" class="add-member-btn" id="addSprintDayBtn" style="margin-top: 15px;">+ Add New Day</button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeSprintPlanModal()">Cancel</button>
                        <button type="submit" class="submit-btn">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Last Week Sprint Modal -->
    <div id="lastWeekSprintModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Submit Last Week Sprint</h3>
                <span class="close-modal" onclick="closeLastWeekSprintModal()">&times;</span>
            </div>
            <div class="modal-body scrollable-content">
                <form id="lastWeekSprintForm" onsubmit="handleLastWeekSprintSubmit(event)">
                    <!-- Hidden field for status check -->
                    <input type="hidden" id="lastWeekSprintEmployeeNameForCheck" value="{{ user.employee_name if user else '' }}">
                    
                    <!-- Read-only fields -->
                    <div class="form-group">
                        <label for="lastWeekSprintEmployeeName">Employee Name</label>
                        <input type="text" id="lastWeekSprintEmployeeName" name="employeeName" readonly style="background-color: #f5f5f5;" value="{{ user.employee_name if user else '' }}">
                    </div>

                    <div class="form-group">
                        <label for="lastWeekSprintEmployeeTeam">Employee Team</label>
                        <input type="text" id="lastWeekSprintEmployeeTeam" name="employeeTeam" readonly style="background-color: #f5f5f5;" value="{{ user.department if user else '' }}">
                    </div>

                    <!-- Special Comment Field -->
                    <div class="form-group">
                        <label for="lastWeekSprintSpecialComment">Special Comment or Extra Comment</label>
                        <textarea id="lastWeekSprintSpecialComment" name="specialComment" rows="3" placeholder="Enter any specific comment or extra information"></textarea>
                    </div>

                    <!-- Day Section -->
                    <hr style="margin: 20px 0; border: none; border-top: 2px solid #ddd;">
                    <div class="form-group">
                        <h3 style="margin-bottom: 15px;">Last Week Sprint Work</h3>
                        
                        <div id="lastWeekSprintDayContainer">
                            <div class="day-entry" data-day-index="0">
                                <div class="form-group">
                                    <label>Date*</label>
                                    <input type="date" class="sprint-date-input" name="dates[]" required>
                                </div>
                                
                                <div class="form-group">
                                    <h4 style="margin-bottom: 10px;">Tasks</h4>
                                    <div id="lastWeekSprintDay0TaskContainer" class="task-container">
                                        <div class="task-entry" data-task-index="0">
                                            <div class="form-group">
                                                <label>Task*</label>
                                                <input type="text" name="tasks[0][]" placeholder="Enter task" required>
                                            </div>
                                            <div class="form-group">
                                                <label>Client Name*</label>
                                                <input type="text" name="clientNames[0][]" placeholder="Enter client name" required>
                                            </div>
                                            <div class="form-group">
                                                <label>Time (Hours)*</label>
                                                <input type="number" name="times[0][]" step="0.01" min="0" placeholder="e.g., 1.25" required>
                                            </div>
                                            <div class="form-group">
                                                <label>Status*</label>
                                                <select name="statuses[0][]" required>
                                                    <option value="">Select Status</option>
                                                    <option value="Completed">Completed</option>
                                                    <option value="Pending">Pending</option>
                                                    <option value="In Progress">In Progress</option>
                                                    <option value="Remove">Remove</option>
                                                    <option value="Take over">Take over</option>
                                                </select>
                                            </div>
                                            <button type="button" onclick="removeLastWeekSprintTask(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">Remove</button>
                                        </div>
                                    </div>
                                    <button type="button" class="add-member-btn add-lastweek-task-btn" data-day="0" style="margin-top: 10px;">+ Add New Task</button>
                                </div>
                                
                                <button type="button" onclick="removeLastWeekSprintDay(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 10px; margin-top: 15px; cursor: pointer; width: 100%;">Remove This Day</button>
                            </div>
                        </div>
                        
                        <button type="button" class="add-member-btn" id="addLastWeekSprintDayBtn" style="margin-top: 15px;">+ Add New Day</button>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeLastWeekSprintModal()">Cancel</button>
                        <button type="submit" class="submit-btn">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Extra Work Modal -->
    <div id="extraWorkModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Submit Extra Work</h3>
                <span class="close-modal" onclick="closeExtraWorkModal()">&times;</span>
            </div>
            <div class="modal-body scrollable-content">
                <form id="extraWorkForm" onsubmit="handleExtraWorkSubmit(event)">
                    <!-- Read-only fields -->
                    <div class="form-group">
                        <label for="extraWorkEmployeeName">Employee Name</label>
                        <input type="text" id="extraWorkEmployeeName" name="employeeName" readonly style="background-color: #f5f5f5;" value="{{ user.employee_name if user else '' }}">
                    </div>

                    <div class="form-group">
                        <label for="extraWorkEmployeeTeam">Employee Team</label>
                        <input type="text" id="extraWorkEmployeeTeam" name="employeeTeam" readonly style="background-color: #f5f5f5;" value="{{ user.department if user else '' }}">
                    </div>

                    <div class="form-group">
                        <label for="extraWorkDate">Date</label>
                        <input type="date" id="extraWorkDate" name="date" readonly style="background-color: #f5f5f5;">
                    </div>

                    <div class="form-group">
                        <label for="extraWorkTime">Time (Hours)*</label>
                        <input type="number" id="extraWorkTime" name="time" step="0.01" min="0" placeholder="e.g., 1.25, 2.5" required>
                    </div>

                    <div class="form-group">
                        <label for="extraWorkTask">Task*</label>
                        <input type="text" id="extraWorkTask" name="task" placeholder="Enter task" required>
                    </div>

                    <div class="form-group">
                        <label for="extraWorkTaskDescription">Task Description*</label>
                        <textarea id="extraWorkTaskDescription" name="taskDescription" rows="3" placeholder="Enter task description" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="extraWorkClient">Client Name*</label>
                        <input type="text" id="extraWorkClient" name="clientName" placeholder="Enter client name" required>
                    </div>

                    <div class="form-group">
                        <label for="extraWorkConcernedPerson">Concerned Person*</label>
                        <input type="text" id="extraWorkConcernedPerson" name="concernedPerson" placeholder="Enter concerned person name" required>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeExtraWorkModal()">Cancel</button>
                        <button type="submit" class="submit-btn">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Leave Approval Request Modal -->
    <div id="leaveApprovalModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Leave Approval Request</h3>
                <span class="close-modal" onclick="closeLeaveApprovalModal()">&times;</span>
            </div>
            <div class="modal-body scrollable-content">
                <form id="leaveApprovalForm">
                    <!-- Employee Name (Default) -->
                    <div class="form-group">
                        <label for="leaveEmployeeName">Employee Name</label>
                        <input type="text" id="leaveEmployeeName" name="employeeName" readonly style="background-color: #f5f5f5;" value="{{ user.employee_name if user else '' }}">
                    </div>

                    <!-- Date (Today's Date by Default) -->
                    <div class="form-group">
                        <label for="leaveRequestDate">Date</label>
                        <input type="date" id="leaveRequestDate" name="requestDate" readonly style="background-color: #f5f5f5;">
                    </div>

                    <!-- Leave Type Radio Buttons -->
                    <div class="form-group">
                        <label>Leave Type*</label>
                        <div class="radio-group">
                            <label><input type="radio" name="leaveType" value="Preplan Leave" checked onchange="toggleCurrentTaskField()"> Preplan Leave</label>
                            <label><input type="radio" name="leaveType" value="Emergency Leave" onchange="toggleCurrentTaskField()"> Emergency Leave</label>
                        </div>
                    </div>

                    <!-- Leave From -->
                    <div class="form-group">
                        <label for="leaveFrom">Leave From*</label>
                        <input type="date" id="leaveFrom" name="leaveFrom" required>
                    </div>

                    <!-- Leave To -->
                    <div class="form-group">
                        <label for="leaveTo">Leave To*</label>
                        <input type="date" id="leaveTo" name="leaveTo" required>
                    </div>

                    <!-- Reason -->
                    <div class="form-group">
                        <label for="leaveReason">Reason*</label>
                        <input type="text" id="leaveReason" name="reason" placeholder="Enter reason for leave" required>
                    </div>

                    <!-- Your current task (Only shown if Emergency Leave is selected) -->
                    <div class="form-group" id="currentTaskField" style="display: none;">
                        <label for="leaveCurrentTask">Your Current Task*</label>
                        <textarea id="leaveCurrentTask" name="currentTask" rows="3" placeholder="Enter your current task details"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeLeaveApprovalModal()">Cancel</button>
                        <button type="button" class="submit-btn" onclick="handleLeaveApprovalSubmit()">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Complaint About Team Modal -->
    <div id="complaintModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Complaint About Team</h3>
                <span class="close-modal" onclick="closeComplaintModal()">&times;</span>
            </div>
            <div class="modal-body scrollable-content">
                <form id="complaintForm">
                    <!-- Employee Name (Default) -->
                    <div class="form-group">
                        <label for="complaintEmployeeName">Employee Name</label>
                        <input type="text" id="complaintEmployeeName" name="employeeName" readonly style="background-color: #f5f5f5;" value="{{ user.employee_name if user else '' }}">
                    </div>

                    <!-- Employee Team (Default) -->
                    <div class="form-group">
                        <label for="complaintEmployeeTeam">Employee Team</label>
                        <input type="text" id="complaintEmployeeTeam" name="employeeTeam" readonly style="background-color: #f5f5f5;" value="{{ user.department if user else '' }}">
                    </div>

                    <!-- Date (Current date by default) -->
                    <div class="form-group">
                        <label for="complaintDate">Date</label>
                        <input type="date" id="complaintDate" name="date" readonly style="background-color: #f5f5f5;">
                    </div>

                    <!-- Person Name -->
                    <div class="form-group">
                        <label for="complaintPersonName">Person Name*</label>
                        <input type="text" id="complaintPersonName" name="personName" placeholder="Enter person name" required>
                    </div>

                    <!-- Complain Description -->
                    <div class="form-group">
                        <label for="complaintDescription">Complain Description*</label>
                        <textarea id="complaintDescription" name="complainDescription" rows="4" placeholder="Enter complaint details" required></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="cancel-btn" onclick="closeComplaintModal()">Cancel</button>
                        <button type="button" class="submit-btn" onclick="handleComplaintSubmit()">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Sidebar Navigation
        document.querySelectorAll('.sidebar nav a').forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.getAttribute('href').startsWith('#')) {
                    e.preventDefault();
                    document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
                    this.classList.add('active');
                    
                    const targetId = this.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            });
        });

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ID Management Functions
        function openCreateIdModal() {
            openModal('createIdModal');
        }


        function openChangeRoleModal() {
            openModal('changeRoleModal');
        }

        // Attendance Functions
        let availableFiles = [];

        function downloadDailyActivityTracker() {
            openModal('dailyTrackerModal');
            loadAvailableTrackerFiles();
        }

        function loadAvailableTrackerFiles() {
            const select = document.getElementById('trackerDateSelect');
            const info = document.getElementById('trackerDateInfo');
            const errorDiv = document.getElementById('trackerDateError');
            const downloadBtn = document.getElementById('trackerDownloadBtn');
            const filenameInput = document.getElementById('selectedFilename');
            
            select.innerHTML = '<option value="">Loading available files...</option>';
            select.disabled = true;
            downloadBtn.disabled = true;
            info.textContent = 'Loading available files...';
            errorDiv.style.display = 'none';
            filenameInput.value = '';
            
            fetch('/hr/get_available_tracker_dates')
                .then(response => response.json())
                .then(data => {
                    select.innerHTML = '<option value="">Select a file</option>';
                    
                    if (data.success && data.dates && data.dates.length > 0) {
                        availableFiles = data.dates;
                        
                        // Populate dropdown with filenames
                        data.dates.forEach(fileInfo => {
                            const option = document.createElement('option');
                            option.value = fileInfo.date; // Store date for backend compatibility
                            option.textContent = fileInfo.filename; // Display filename
                            option.setAttribute('data-filename', fileInfo.filename);
                            select.appendChild(option);
                        });
                        
                        info.textContent = `${data.dates.length} file(s) available for download.`;
                        select.disabled = false;
                        
                        // Add event listener for selection change
                        select.addEventListener('change', function() {
                            const selectedOption = select.options[select.selectedIndex];
                            if (selectedOption.value) {
                                filenameInput.value = selectedOption.getAttribute('data-filename');
                                downloadBtn.disabled = false;
                                errorDiv.style.display = 'none';
                            } else {
                                filenameInput.value = '';
                                downloadBtn.disabled = true;
                            }
                        });
                    } else {
                        select.innerHTML = '<option value="">No files available</option>';
                        info.textContent = 'No activity tracker files found in the system.';
                        select.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error loading available files:', error);
                    select.innerHTML = '<option value="">Error loading files</option>';
                    info.textContent = 'Error loading available files. Please try again.';
                    select.disabled = true;
                });
        }

        function openTimeRangeTrackerModal() {
            openModal('timeRangeTrackerModal');
            initializeTimeRangeForm();
        }

        function initializeTimeRangeForm() {
            const startDateInput = document.getElementById('startDateInput');
            const endDateInput = document.getElementById('endDateInput');
            const errorDiv = document.getElementById('timeRangeError');
            const downloadBtn = document.getElementById('timeRangeDownloadBtn');
            
            // Set max date to today
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            startDateInput.setAttribute('max', todayStr);
            endDateInput.setAttribute('max', todayStr);
            
            // Clear previous values
            startDateInput.value = '';
            endDateInput.value = '';
            errorDiv.style.display = 'none';
            downloadBtn.disabled = false;
            
            // Add validation for date range
            function validateDateRange() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                if (startDate && endDate) {
                    if (startDate > endDate) {
                        errorDiv.textContent = 'Start date must be before or equal to end date.';
                        errorDiv.style.display = 'block';
                        downloadBtn.disabled = true;
                    } else {
                        errorDiv.style.display = 'none';
                        downloadBtn.disabled = false;
                    }
                } else {
                    errorDiv.style.display = 'none';
                    downloadBtn.disabled = false;
                }
            }
            
            startDateInput.addEventListener('change', validateDateRange);
            endDateInput.addEventListener('change', validateDateRange);
        }

        function openAttendanceRecordModal() {
            openModal('attendanceRecordModal');
        }

        function openPersonalActivityTrackerModal() {
            openModal('personalActivityTrackerModal');
            loadPersonalTrackerEmployeeList();
        }

        function loadPersonalTrackerEmployeeList() {
            const select = document.getElementById('employeeNameSelect');
            select.innerHTML = '<option value="">Loading employees...</option>';
            select.disabled = true;
            
            fetch('/api/get_users_list')
                .then(response => response.json())
                .then(data => {
                    select.innerHTML = '<option value="">Select Employee</option>';
                    
                    if (data.success && data.users) {
                        data.users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.employee_name; // Use employee_name as value for backend
                            option.textContent = user.employee_name;
                            select.appendChild(option);
                        });
                        select.disabled = false;
                    } else {
                        select.innerHTML = '<option value="">No employees found</option>';
                        select.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error loading employees:', error);
                    select.innerHTML = '<option value="">Error loading employees</option>';
                    select.disabled = true;
                });
        }

        function openClientWiseActivityTrackerModal() {
            openModal('clientWiseActivityTrackerModal');
        }

        function openExtraWorkActivityTrackerModal() {
            openModal('extraWorkActivityTrackerModal');
            loadExtraWorkEntries();
        }

        function openDownloadExtraWorkModal() {
            openModal('downloadExtraWorkModal');
        }

        function openAttendanceWithExtraWorkModal() {
            openModal('attendanceWithExtraWorkModal');
        }

        function loadExtraWorkEntries() {
            const loadingDiv = document.getElementById('extraWorkLoading');
            const contentDiv = document.getElementById('extraWorkContent');
            const messageDiv = document.getElementById('extraWorkMessage');
            const tableBody = document.getElementById('extraWorkTableBody');
            
            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';
            tableBody.innerHTML = '';
            
            fetch('/hr/get_extra_work_entries')
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';
                    
                    if (data.success && data.entries && data.entries.length > 0) {
                        messageDiv.textContent = `Found ${data.entries.length} unapproved extra work entries.`;
                        messageDiv.style.backgroundColor = '#e8f4f8';
                        messageDiv.style.color = '#333';
                        
                        data.entries.forEach((entry, index) => {
                            const row = document.createElement('tr');
                            // Escape special characters in source_file for JavaScript
                            const safeSourceFile = (entry.source_file || '').replace(/'/g, "\\'");
                            row.innerHTML = `
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${index + 1}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${entry.employee_name || ''}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${entry.date || ''}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${entry.task || ''}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${entry.time || ''}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${entry.client || ''}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${entry.source_file || ''}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                                    <button onclick="approveDeclineExtraWork(${index}, 'approved', '${safeSourceFile}', ${entry.row_index})" 
                                            class="submit-btn" style="padding: 5px 10px; margin: 2px; font-size: 0.85rem;">Approve</button>
                                    <button onclick="approveDeclineExtraWork(${index}, 'declined', '${safeSourceFile}', ${entry.row_index})" 
                                            class="cancel-btn" style="padding: 5px 10px; margin: 2px; font-size: 0.85rem;">Decline</button>
                                </td>
                            `;
                            row.setAttribute('data-entry-index', index);
                            tableBody.appendChild(row);
                        });
                    } else {
                        messageDiv.textContent = 'No unapproved extra work entries found.';
                        messageDiv.style.backgroundColor = '#f0f0f0';
                        messageDiv.style.color = '#666';
                    }
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'block';
                    messageDiv.textContent = 'Error loading extra work entries. Please try again.';
                    messageDiv.style.backgroundColor = '#fee';
                    messageDiv.style.color = '#c00';
                    console.error('Error loading extra work entries:', error);
                });
        }

        function approveDeclineExtraWork(entryIndex, status, sourceFile, rowIndex) {
            if (!confirm(`Are you sure you want to ${status === 'approved' ? 'approve' : 'decline'} this entry?`)) {
                return;
            }
            
            fetch('/hr/approve_decline_extra_work', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    source_file: sourceFile,
                    row_index: rowIndex,
                    status: status
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the row from the table
                    const row = document.querySelector(`tr[data-entry-index="${entryIndex}"]`);
                    if (row) {
                        row.remove();
                    }
                    
                    // Update message
                    const remainingRows = document.querySelectorAll('#extraWorkTableBody tr').length;
                    const messageDiv = document.getElementById('extraWorkMessage');
                    if (remainingRows === 0) {
                        messageDiv.textContent = 'All entries have been processed.';
                        messageDiv.style.backgroundColor = '#e8f4f8';
                    } else {
                        messageDiv.textContent = `${remainingRows} unapproved extra work entries remaining.`;
                    }
                } else {
                    alert(`Error: ${data.message || 'Failed to process entry'}`);
                }
            })
            .catch(error => {
                console.error('Error processing entry:', error);
                alert('Error processing entry. Please try again.');
            });
        }

        // Broadcast Mail Functions
        function openUpdateClientMailListModal() {
            openModal('updateClientMailListModal');
            loadClientMailList();
        }

        function loadClientMailList() {
            const loadingDiv = document.getElementById('clientMailLoading');
            const listDiv = document.getElementById('clientMailList');
            const contentDiv = document.getElementById('clientMailListContent');
            
            loadingDiv.style.display = 'block';
            listDiv.style.display = 'none';
            contentDiv.innerHTML = '';
            
            fetch('/hr/get_client_mail_list')
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    listDiv.style.display = 'block';
                    
                    if (data.success && data.emails && data.emails.length > 0) {
                        contentDiv.innerHTML = '';
                        data.emails.forEach((emailData, index) => {
                            const emailItem = document.createElement('div');
                            emailItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background-color: #f5f5f5; border-radius: 5px; border: 1px solid #ddd;';
                            emailItem.innerHTML = `
                                <span style="flex: 1; font-size: 1rem;">${index + 1}. ${emailData.email}</span>
                                <button onclick="removeClientMail(${emailData.id})" 
                                        class="cancel-btn" 
                                        style="padding: 5px 15px; font-size: 0.9rem; margin-left: 10px;">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            `;
                            contentDiv.appendChild(emailItem);
                        });
                    } else {
                        contentDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No client mail addresses found. Click "Add New Email" to add one.</p>';
                    }
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    listDiv.style.display = 'block';
                    contentDiv.innerHTML = '<p style="text-align: center; color: #c00; padding: 20px;">Error loading client mail list. Please try again.</p>';
                    console.error('Error loading client mail list:', error);
                });
        }

        function showAddClientMailForm() {
            document.getElementById('addClientMailForm').style.display = 'block';
            document.getElementById('newClientEmail').value = '';
            document.getElementById('newClientEmail').focus();
        }

        function hideAddClientMailForm() {
            document.getElementById('addClientMailForm').style.display = 'none';
            document.getElementById('newClientEmail').value = '';
        }

        function addClientMail() {
            const emailInput = document.getElementById('newClientEmail');
            const email = emailInput.value.trim();
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            // Basic email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            fetch('/hr/add_client_mail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    emailInput.value = '';
                    hideAddClientMailForm();
                    loadClientMailList(); // Reload the list
                } else {
                    alert(`Error: ${data.message || 'Failed to add email address'}`);
                }
            })
            .catch(error => {
                console.error('Error adding client mail:', error);
                alert('Error adding email address. Please try again.');
            });
        }

        function removeClientMail(mailId) {
            if (!confirm('Are you sure you want to remove this email address?')) {
                return;
            }
            
            fetch('/hr/remove_client_mail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mail_id: mailId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadClientMailList(); // Reload the list
                } else {
                    alert(`Error: ${data.message || 'Failed to remove email address'}`);
                }
            })
            .catch(error => {
                console.error('Error removing client mail:', error);
                alert('Error removing email address. Please try again.');
            });
        }

        function openSendClientMailModal() {
            openModal('sendClientMailModal');
            // Clear form when opening
            document.getElementById('clientMailSubject').value = '';
            document.getElementById('clientMailContentEditor').innerHTML = '';
            document.getElementById('clientMailAttachments').value = '';
            document.getElementById('attachmentPreview').innerHTML = '';
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('clientMailContentEditor').focus();
        }

        // Handle file selection preview
        document.getElementById('clientMailAttachments').addEventListener('change', function(e) {
            const preview = document.getElementById('attachmentPreview');
            preview.innerHTML = '';
            if (this.files.length > 0) {
                const fileList = document.createElement('div');
                fileList.style.cssText = 'padding: 10px; background-color: #f5f5f5; border-radius: 4px;';
                fileList.innerHTML = '<strong>Selected files:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                for (let i = 0; i < this.files.length; i++) {
                    fileList.innerHTML += `<li>${this.files[i].name} (${(this.files[i].size / 1024).toFixed(2)} KB)</li>`;
                }
                fileList.innerHTML += '</ul>';
                preview.appendChild(fileList);
            }
        });

        // Handle form submission
        document.getElementById('sendClientMailForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const subject = document.getElementById('clientMailSubject').value.trim();
            const content = document.getElementById('clientMailContentEditor').innerHTML;
            const attachments = document.getElementById('clientMailAttachments').files;
            
            if (!subject) {
                alert('Please enter a subject');
                return;
            }
            
            if (!content || content.trim() === '' || content === '<br>') {
                alert('Please enter email content');
                return;
            }
            
            // Store HTML content in hidden field
            document.getElementById('clientMailContentHidden').value = content;
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('subject', subject);
            formData.append('content', content);
            
            // Add all attachments
            for (let i = 0; i < attachments.length; i++) {
                formData.append('attachments', attachments[i]);
            }
            
            // Disable submit button
            const submitBtn = document.getElementById('sendClientMailBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            
            fetch('/hr/send_client_mail', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Mail to All Clients';
                
                if (data.success) {
                    alert(`Email sent successfully to ${data.sent_count} client(s)!`);
                    closeModal('sendClientMailModal');
                    // Reset form
                    document.getElementById('clientMailSubject').value = '';
                    document.getElementById('clientMailContentEditor').innerHTML = '';
                    document.getElementById('clientMailAttachments').value = '';
                    document.getElementById('attachmentPreview').innerHTML = '';
                } else {
                    alert(`Error: ${data.message || 'Failed to send emails'}`);
                }
            })
            .catch(error => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Mail to All Clients';
                console.error('Error sending email:', error);
                alert('Error sending emails. Please try again.');
            });
        });

        function openSendEmployeeMailModal() {
            openModal('sendEmployeeMailModal');
            // Clear form when opening
            document.getElementById('employeeMailSubject').value = '';
            document.getElementById('employeeMailContentEditor').innerHTML = '';
            document.getElementById('employeeMailAttachments').value = '';
            document.getElementById('employeeAttachmentPreview').innerHTML = '';
        }

        function formatEmployeeText(command) {
            document.execCommand(command, false, null);
            document.getElementById('employeeMailContentEditor').focus();
        }

        // Handle file selection preview for employee mail
        document.getElementById('employeeMailAttachments').addEventListener('change', function(e) {
            const preview = document.getElementById('employeeAttachmentPreview');
            preview.innerHTML = '';
            if (this.files.length > 0) {
                const fileList = document.createElement('div');
                fileList.style.cssText = 'padding: 10px; background-color: #f5f5f5; border-radius: 4px;';
                fileList.innerHTML = '<strong>Selected files:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
                for (let i = 0; i < this.files.length; i++) {
                    fileList.innerHTML += `<li>${this.files[i].name} (${(this.files[i].size / 1024).toFixed(2)} KB)</li>`;
                }
                fileList.innerHTML += '</ul>';
                preview.appendChild(fileList);
            }
        });

        // Handle employee mail form submission
        document.getElementById('sendEmployeeMailForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const subject = document.getElementById('employeeMailSubject').value.trim();
            const content = document.getElementById('employeeMailContentEditor').innerHTML;
            const attachments = document.getElementById('employeeMailAttachments').files;
            
            if (!subject) {
                alert('Please enter a subject');
                return;
            }
            
            if (!content || content.trim() === '' || content === '<br>') {
                alert('Please enter email content');
                return;
            }
            
            // Store HTML content in hidden field
            document.getElementById('employeeMailContentHidden').value = content;
            
            // Create FormData for file upload
            const formData = new FormData();
            formData.append('subject', subject);
            formData.append('content', content);
            
            // Add all attachments
            for (let i = 0; i < attachments.length; i++) {
                formData.append('attachments', attachments[i]);
            }
            
            // Disable submit button
            const submitBtn = document.getElementById('sendEmployeeMailBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';
            
            fetch('/hr/send_employee_mail', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Mail to Employees';
                
                if (data.success) {
                    alert(`Email sent successfully to ${data.sent_count} employee(s)!`);
                    closeModal('sendEmployeeMailModal');
                    // Reset form
                    document.getElementById('employeeMailSubject').value = '';
                    document.getElementById('employeeMailContentEditor').innerHTML = '';
                    document.getElementById('employeeMailAttachments').value = '';
                    document.getElementById('employeeAttachmentPreview').innerHTML = '';
                } else {
                    alert(`Error: ${data.message || 'Failed to send emails'}`);
                }
            })
            .catch(error => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Mail to Employees';
                console.error('Error sending email:', error);
                alert('Error sending emails. Please try again.');
            });
        });

        function openCustomBroadcastMailModal() {
            openModal('customBroadcastMailModal');
        }

        // Catalog Functions
        function downloadCatalog() {
            openModal('downloadCatalogModal');
        }

        function downloadCatalogFile(catalogType) {
            // Map catalog types to their file paths
            const catalogFiles = {
                'infrastructure': 'Infrastructure VAPT Catalog.xlsx',
                'public_ip': 'Public IP VAPT Catalog.xlsx',
                'website': 'Website VAPT Catalog.xlsx'
            };

            const filename = catalogFiles[catalogType];
            if (!filename) {
                alert('Invalid catalog type');
                return;
            }

            // Create download link
            const downloadUrl = `/hr/download_catalog/${catalogType}`;
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Close modal after download starts
            closeModal('downloadCatalogModal');
        }

        function openUploadCatalogModal() {
            // Reset modal to step 1
            document.getElementById('uploadCatalogTypeSelection').style.display = 'block';
            document.getElementById('uploadCatalogFileForm').style.display = 'none';
            document.getElementById('uploadCatalogForm').reset();
            document.getElementById('selectedCatalogType').value = '';
            openModal('uploadCatalogModal');
        }

        function selectCatalogType(catalogType) {
            // Store selected catalog type
            document.getElementById('selectedCatalogType').value = catalogType;
            
            // Update label based on catalog type
            const catalogLabels = {
                'infrastructure': 'Upload Infrastructure VAPT Catalog File*',
                'public_ip': 'Upload Public IP VAPT Catalog File*',
                'website': 'Upload Website VAPT Catalog File*'
            };
            document.getElementById('uploadCatalogTypeLabel').textContent = catalogLabels[catalogType] || 'Select Catalog File*';
            
            // Show file upload form, hide type selection
            document.getElementById('uploadCatalogTypeSelection').style.display = 'none';
            document.getElementById('uploadCatalogFileForm').style.display = 'block';
        }

        function backToCatalogTypeSelection() {
            // Reset form and go back to step 1
            document.getElementById('uploadCatalogForm').reset();
            document.getElementById('selectedCatalogType').value = '';
            document.getElementById('uploadCatalogTypeSelection').style.display = 'block';
            document.getElementById('uploadCatalogFileForm').style.display = 'none';
        }

        function closeUploadCatalogModal() {
            // Reset modal state
            backToCatalogTypeSelection();
            closeModal('uploadCatalogModal');
        }

        // Handle upload catalog form submission
        document.getElementById('uploadCatalogForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const catalogType = document.getElementById('selectedCatalogType').value;
            const fileInput = document.getElementById('catalogFileInput');
            
            if (!catalogType) {
                alert('Please select a catalog type first');
                return;
            }
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a file to upload');
                return;
            }
            
            // Validate file type
            const file = fileInput.files[0];
            const validExtensions = ['.xlsx', '.xls'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validExtensions.includes(fileExtension)) {
                alert('Please upload an Excel file (.xlsx or .xls)');
                return;
            }
            
            // Create FormData
            const formData = new FormData();
            formData.append('catalog_file', file);
            formData.append('catalog_type', catalogType);
            
            // Disable submit button
            const submitBtn = document.getElementById('uploadCatalogBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';
            
            fetch('/hr/upload_catalog', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload';
                
                if (data.success) {
                    alert(data.message || 'Catalog file uploaded successfully!');
                    closeUploadCatalogModal();
                } else {
                    alert(`Error: ${data.message || 'Failed to upload catalog file'}`);
                }
            })
            .catch(error => {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload';
                console.error('Error uploading catalog:', error);
                alert('Error uploading catalog file. Please try again.');
            });
        });

        // Employee Performance Functions
        function loadEmployeesForPerformance(metricType) {
            return fetch('/hr/get_all_employees')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.employees) {
                        return data.employees;
                    }
                    return [];
                })
                .catch(error => {
                    console.error('Error loading employees:', error);
                    return [];
                });
        }

        function populateEmployeeList(containerId, employees) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            employees.forEach(employee => {
                const row = document.createElement('div');
                row.style.cssText = 'display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee;';
                row.innerHTML = `
                    <div style="flex: 1; font-weight: 500;">${employee.employee_name || employee.username}</div>
                    <div style="flex: 0 0 200px;">
                        <input type="number" 
                               name="employee_${employee.id}" 
                               data-employee-id="${employee.id}"
                               min="1" 
                               max="10" 
                               step="0.1"
                               placeholder="1-10"
                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                               required>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        async function openPunctualityModal() {
            openModal('punctualityModal');
            const employees = await loadEmployeesForPerformance('punctuality');
            populateEmployeeList('punctualityEmployeesList', employees);
        }

        async function openBehaviourModal() {
            openModal('behaviourModal');
            const employees = await loadEmployeesForPerformance('behaviour');
            populateEmployeeList('behaviourEmployeesList', employees);
        }

        async function openTeamCoordinationModal() {
            openModal('teamCoordinationModal');
            const employees = await loadEmployeesForPerformance('team_coordination');
            populateEmployeeList('teamCoordinationEmployeesList', employees);
        }

        async function openCommunicationSkillsModal() {
            openModal('communicationSkillsModal');
            const employees = await loadEmployeesForPerformance('communication_skills');
            populateEmployeeList('communicationSkillsEmployeesList', employees);
        }

        // Initialize performance form handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Punctuality form
            document.getElementById('punctualityForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handlePerformanceSubmit('punctualityForm', 'punctuality', 'punctualitySubmitBtn', 'punctualityModal');
            });

            // Behaviour form
            document.getElementById('behaviourForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handlePerformanceSubmit('behaviourForm', 'behaviour', 'behaviourSubmitBtn', 'behaviourModal');
            });

            // Team Coordination form
            document.getElementById('teamCoordinationForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handlePerformanceSubmit('teamCoordinationForm', 'team_coordination', 'teamCoordinationSubmitBtn', 'teamCoordinationModal');
            });

            // Communication Skills form
            document.getElementById('communicationSkillsForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handlePerformanceSubmit('communicationSkillsForm', 'communication_skills', 'communicationSkillsSubmitBtn', 'communicationSkillsModal');
            });
        });

        async function handlePerformanceSubmit(formId, metricType, submitBtnId, modalId) {
            const form = document.getElementById(formId);
            const submitBtn = document.getElementById(submitBtnId);
            
            const formData = new FormData();
            const inputs = form.querySelectorAll('input[type="number"]');
            let hasData = false;
            let hasError = false;
            
            inputs.forEach(input => {
                const employeeId = input.getAttribute('data-employee-id');
                const value = parseFloat(input.value);
                const employeeName = input.closest('div').previousElementSibling.textContent.trim();
                
                if (input.value !== '' && !isNaN(value)) {
                    if (value < 1 || value > 10) {
                        alert(`Rating for ${employeeName} must be between 1 and 10`);
                        hasError = true;
                        return;
                    }
                    formData.append(`employee_${employeeId}`, value);
                    hasData = true;
                }
            });
            
            if (hasError) return;
            
            if (!hasData) {
                alert('Please enter at least one rating');
                return;
            }
            
            formData.append('metric_type', metricType);
            
            submitBtn.disabled = true;
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Saving...';
            
            try {
                const response = await fetch('/hr/save_performance_data', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message || 'Performance data saved successfully!');
                    closeModal(modalId);
                    form.reset();
                } else {
                    alert(`Error: ${data.message || 'Failed to save performance data'}`);
                }
            } catch (error) {
                console.error('Error saving performance data:', error);
                alert('Error saving performance data. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Work Plan Modal Functions
        function openWorkPlanModal() {
            // Check if already disabled
            const workCard = document.getElementById('workPlanCard');
            if (workCard && workCard.classList.contains('work-plan-submitted')) {
                return; // Don't open if already submitted
            }
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('workPlanDate').value = today;
            
            // Open modal
            document.getElementById('workPlanModal').style.display = 'block';
        }
        
        function closeWorkPlanModal() {
            document.getElementById('workPlanModal').style.display = 'none';
            // Reset form
            const form = document.getElementById('workPlanForm');
            if (form) {
                form.reset();
                // Reset to first task only
                const taskContainer = document.getElementById('workPlanTaskContainer');
                if (taskContainer) {
                    const firstTask = taskContainer.querySelector('.task-entry');
                    taskContainer.innerHTML = '';
                    if (firstTask) {
                        taskContainer.appendChild(firstTask.cloneNode(true));
                    }
                }
            }
        }
        
        // Check work plan status on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check if work plan has already been submitted today
            const today = new Date().toISOString().split('T')[0];
            const employeeName = document.getElementById('workPlanEmployeeNameForCheck')?.value || '';
            
            if (employeeName) {
                const formData = new FormData();
                formData.append('date', today);
                formData.append('employeeName', employeeName);
                
                fetch('/check_work_plan_status', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.submitted) {
                        const workCard = document.getElementById('workPlanCard');
                        if (workCard) {
                            workCard.classList.add('work-plan-submitted');
                            workCard.style.cursor = 'not-allowed';
                            workCard.style.opacity = '0.6';
                            workCard.onclick = null;
                            
                            const icon = workCard.querySelector('i');
                            const heading = workCard.querySelector('h3');
                            if (icon) icon.style.opacity = '0.5';
                            if (heading) {
                                heading.textContent = 'Work Plan Submitted Today';
                                heading.style.color = '#888';
                            }
                        }
                    }
                })
                .catch(error => console.error('Error checking work plan status:', error));
            }
            
            // Add Task functionality
            const addTaskBtn = document.getElementById('addWorkPlanTaskBtn');
            if (addTaskBtn) {
                addTaskBtn.addEventListener('click', function() {
                    const taskContainer = document.getElementById('workPlanTaskContainer');
                    const tasks = taskContainer.querySelectorAll('.task-entry');
                    
                    if (tasks.length >= 10) {
                        alert('Maximum 10 tasks allowed');
                        return;
                    }
                    
                    const newIndex = tasks.length;
                    const newTask = document.createElement('div');
                    newTask.className = 'task-entry';
                    newTask.setAttribute('data-task-index', newIndex);
                    newTask.innerHTML = `
                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
                        <div class="form-group">
                            <label for="workPlanTask_${newIndex}">Task*</label>
                            <input type="text" id="workPlanTask_${newIndex}" name="task[]" placeholder="Enter task name" required>
                        </div>

                        <div class="form-group">
                            <label for="workPlanTaskDescription_${newIndex}">Task Description*</label>
                            <textarea id="workPlanTaskDescription_${newIndex}" name="taskDescription[]" rows="2" placeholder="Enter task description" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="workPlanClientName_${newIndex}">Client Name*</label>
                            <input type="text" id="workPlanClientName_${newIndex}" name="clientName[]" placeholder="Enter client name" required>
                        </div>

                        <div class="form-group">
                            <label for="workPlanTime_${newIndex}">Time Taken (in Hours)*</label>
                            <input type="number" id="workPlanTime_${newIndex}" name="time[]" step="0.01" min="0" placeholder="e.g., 1.25, 2.5" required>
                        </div>
                        
                        <button type="button" onclick="removeWorkPlanTask(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 10px; margin-top: 10px; cursor: pointer;">Remove Task</button>
                    `;
                    taskContainer.appendChild(newTask);
                });
            }
        });
        
        function removeWorkPlanTask(button) {
            const taskEntry = button.closest('.task-entry');
            if (taskEntry) {
                taskEntry.remove();
            }
        }
        
        // Work Plan Form Submission Handler
        function handleWorkPlanSubmit(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            const formData = new FormData(event.target);
            
            fetch('/submit_work_plan', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                if (data.success) {
                    alert('Work plan submitted successfully!');
                    closeWorkPlanModal();
                    
                    const workCard = document.getElementById('workPlanCard');
                    if (workCard) {
                        workCard.classList.add('work-plan-submitted');
                        workCard.style.cursor = 'not-allowed';
                        workCard.style.opacity = '0.6';
                        workCard.onclick = null;
                        
                        const icon = workCard.querySelector('i');
                        const heading = workCard.querySelector('h3');
                        if (icon) icon.style.opacity = '0.5';
                        if (heading) {
                            heading.textContent = 'Work Plan Submitted Today';
                            heading.style.color = '#888';
                        }
                    }
                    
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert(data.error || 'Failed to submit work plan');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during submission. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        }
        
        // Update Work Modal Functions
        function openUpdateWorkModal() {
            const workCard = document.getElementById('updateWorkCard');
            if (workCard && workCard.classList.contains('update-work-submitted')) {
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('updateWorkDate').value = today;
            document.getElementById('updateWorkModal').style.display = 'block';
        }
        
        function closeUpdateWorkModal() {
            document.getElementById('updateWorkModal').style.display = 'none';
            const form = document.getElementById('updateWorkForm');
            if (form) {
                form.reset();
                const taskContainer = document.getElementById('updateWorkTaskContainer');
                if (taskContainer) {
                    const firstTask = taskContainer.querySelector('.task-entry');
                    taskContainer.innerHTML = '';
                    if (firstTask) {
                        taskContainer.appendChild(firstTask.cloneNode(true));
                    }
                }
            }
        }
        
        // Add Update Work Task functionality
        document.addEventListener('DOMContentLoaded', function() {
            const addUpdateTaskBtn = document.getElementById('addUpdateWorkTaskBtn');
            if (addUpdateTaskBtn) {
                addUpdateTaskBtn.addEventListener('click', function() {
                    const taskContainer = document.getElementById('updateWorkTaskContainer');
                    const tasks = taskContainer.querySelectorAll('.task-entry');
                    
                    if (tasks.length >= 10) {
                        alert('Maximum 10 tasks allowed');
                        return;
                    }
                    
                    const newIndex = tasks.length;
                    const newTask = document.createElement('div');
                    newTask.className = 'task-entry';
                    newTask.setAttribute('data-task-index', newIndex);
                    newTask.innerHTML = `
                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
                        <div class="form-group">
                            <label for="updateWorkTask_${newIndex}">Task*</label>
                            <input type="text" id="updateWorkTask_${newIndex}" name="task[]" placeholder="Enter task name" required>
                        </div>

                        <div class="form-group">
                            <label for="updateWorkClientName_${newIndex}">Client Name*</label>
                            <input type="text" id="updateWorkClientName_${newIndex}" name="clientName[]" placeholder="Enter client name" required>
                        </div>

                        <div class="form-group">
                            <label for="updateWorkTime_${newIndex}">Time Taken (in Hours)*</label>
                            <input type="number" id="updateWorkTime_${newIndex}" name="time[]" step="0.01" min="0" placeholder="e.g., 1.25, 2.5" required>
                        </div>

                        <div class="form-group">
                            <label for="updateWorkStatus_${newIndex}">Status*</label>
                            <select id="updateWorkStatus_${newIndex}" name="status[]" required>
                                <option value="">Select Status</option>
                                <option value="Completed">Completed</option>
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Remove">Remove</option>
                                <option value="Take over">Take over</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="updateWorkDescription_${newIndex}">Description*</label>
                            <textarea id="updateWorkDescription_${newIndex}" name="description[]" rows="2" placeholder="Enter description" required></textarea>
                        </div>
                        
                        <button type="button" onclick="removeUpdateWorkTask(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 10px; margin-top: 10px; cursor: pointer;">Remove Task</button>
                    `;
                    taskContainer.appendChild(newTask);
                });
            }
            
            // Check update work status on page load
            const today = new Date().toISOString().split('T')[0];
            const employeeName = document.getElementById('updateWorkEmployeeNameForCheck')?.value || '';
            
            if (employeeName) {
                const formData = new FormData();
                formData.append('date', today);
                formData.append('employeeName', employeeName);
                
                fetch('/check_update_work_status', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.submitted) {
                        const workCard = document.getElementById('updateWorkCard');
                        if (workCard) {
                            workCard.classList.add('update-work-submitted');
                            workCard.style.cursor = 'not-allowed';
                            workCard.style.opacity = '0.6';
                            workCard.onclick = null;
                            
                            const icon = workCard.querySelector('i');
                            const heading = workCard.querySelector('h3');
                            if (icon) icon.style.opacity = '0.5';
                            if (heading) {
                                heading.textContent = 'Work Updated Today';
                                heading.style.color = '#888';
                            }
                        }
                    }
                })
                .catch(error => console.error('Error checking update work status:', error));
            }
            
            // Check sprint plan status on page load
            const sprintEmployeeName = document.getElementById('sprintPlanEmployeeNameForCheck')?.value || '';
            
            if (sprintEmployeeName) {
                const sprintFormData = new FormData();
                sprintFormData.append('employeeName', sprintEmployeeName);
                
                fetch('/check_sprint_plan_status', {
                    method: 'POST',
                    body: sprintFormData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.submitted) {
                        const sprintCard = document.getElementById('sprintPlanCard');
                        if (sprintCard) {
                            sprintCard.classList.add('sprint-plan-submitted');
                            sprintCard.style.cursor = 'not-allowed';
                            sprintCard.style.opacity = '0.6';
                            sprintCard.onclick = null;
                            
                            const icon = sprintCard.querySelector('i');
                            const heading = sprintCard.querySelector('h3');
                            if (icon) icon.style.opacity = '0.5';
                            if (heading) {
                                heading.textContent = 'Sprint Plan Submitted';
                                heading.style.color = '#888';
                            }
                        }
                    }
                })
                .catch(error => console.error('Error checking sprint plan status:', error));
            }
            
            // Check last week sprint status on page load
            const lastWeekEmployeeName = document.getElementById('lastWeekSprintEmployeeNameForCheck')?.value || '';
            
            if (lastWeekEmployeeName) {
                const lastWeekFormData = new FormData();
                lastWeekFormData.append('employeeName', lastWeekEmployeeName);
                
                fetch('/check_last_week_sprint_status', {
                    method: 'POST',
                    body: lastWeekFormData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.submitted) {
                        const sprintCard = document.getElementById('lastWeekSprintCard');
                        if (sprintCard) {
                            sprintCard.classList.add('last-week-sprint-submitted');
                            sprintCard.style.cursor = 'not-allowed';
                            sprintCard.style.opacity = '0.6';
                            sprintCard.onclick = null;
                            
                            const icon = sprintCard.querySelector('i');
                            const heading = sprintCard.querySelector('h3');
                            if (icon) icon.style.opacity = '0.5';
                            if (heading) {
                                heading.textContent = 'Last Week Sprint Submitted';
                                heading.style.color = '#888';
                            }
                        }
                    }
                })
                .catch(error => console.error('Error checking last week sprint status:', error));
            }
        });
        
        function removeUpdateWorkTask(button) {
            const taskEntry = button.closest('.task-entry');
            if (taskEntry) {
                taskEntry.remove();
            }
        }
        
        // Update Work Form Submission Handler
        function handleUpdateWorkSubmit(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            const formData = new FormData(event.target);
            
            fetch('/submit_update_work', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                if (data.success) {
                    alert('Work updated successfully!');
                    closeUpdateWorkModal();
                    
                    const workCard = document.getElementById('updateWorkCard');
                    if (workCard) {
                        workCard.classList.add('update-work-submitted');
                        workCard.style.cursor = 'not-allowed';
                        workCard.style.opacity = '0.6';
                        workCard.onclick = null;
                        
                        const icon = workCard.querySelector('i');
                        const heading = workCard.querySelector('h3');
                        if (icon) icon.style.opacity = '0.5';
                        if (heading) {
                            heading.textContent = 'Work Updated Today';
                            heading.style.color = '#888';
                        }
                    }
                    
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert(data.error || 'Failed to update work');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        }
        
        // Sprint Plan Modal Functions
        function openSprintPlanModal() {
            const sprintCard = document.getElementById('sprintPlanCard');
            if (sprintCard && sprintCard.classList.contains('sprint-plan-submitted')) {
                return;
            }
            document.getElementById('sprintPlanModal').style.display = 'block';
        }
        
        function closeSprintPlanModal() {
            document.getElementById('sprintPlanModal').style.display = 'none';
            const form = document.getElementById('sprintPlanForm');
            if (form) {
                form.reset();
                const dayContainer = document.getElementById('sprintPlanDayContainer');
                if (dayContainer) {
                    const firstDay = dayContainer.querySelector('.day-entry');
                    dayContainer.innerHTML = '';
                    if (firstDay) {
                        dayContainer.appendChild(firstDay.cloneNode(true));
                    }
                }
            }
        }
        
        // Sprint Plan JavaScript
        let sprintDayIndex = 0;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Add New Day functionality
            const addDayBtn = document.getElementById('addSprintDayBtn');
            if (addDayBtn) {
                addDayBtn.addEventListener('click', function() {
                    const dayContainer = document.getElementById('sprintPlanDayContainer');
                    const days = dayContainer.querySelectorAll('.day-entry');
                    
                    if (days.length >= 6) {
                        alert('Maximum 6 days allowed');
                        return;
                    }
                    
                    sprintDayIndex++;
                    const newDay = document.createElement('div');
                    newDay.className = 'day-entry';
                    newDay.setAttribute('data-day-index', sprintDayIndex);
                    newDay.innerHTML = `
                        <hr style="margin: 20px 0; border: none; border-top: 2px solid #ddd;">
                        <div class="form-group">
                            <label>Date*</label>
                            <input type="date" class="sprint-date-input" name="dates[]" required>
                        </div>
                        
                        <div class="form-group">
                            <h4 style="margin-bottom: 10px;">Tasks</h4>
                            <div id="sprintDay${sprintDayIndex}TaskContainer" class="task-container">
                                <div class="task-entry" data-task-index="0">
                                    <div class="form-group">
                                        <label>Task*</label>
                                        <input type="text" name="tasks[${sprintDayIndex}][]" placeholder="Enter task" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Client Name*</label>
                                        <input type="text" name="clientNames[${sprintDayIndex}][]" placeholder="Enter client name" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Time (Hours)*</label>
                                        <input type="number" name="times[${sprintDayIndex}][]" step="0.01" min="0" placeholder="e.g., 1.25" required>
                                    </div>
                                    <button type="button" onclick="removeSprintTask(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="add-member-btn add-sprint-task-btn" data-day="${sprintDayIndex}" style="margin-top: 10px;">+ Add New Task</button>
                        </div>
                        
                        <button type="button" onclick="removeSprintDay(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 10px; margin-top: 15px; cursor: pointer; width: 100%;">Remove This Day</button>
                    `;
                    dayContainer.appendChild(newDay);
                });
            }
            
            // Add New Task functionality (delegated)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('add-sprint-task-btn')) {
                    const dayIndex = e.target.getAttribute('data-day');
                    const taskContainer = document.getElementById(`sprintDay${dayIndex}TaskContainer`);
                    const tasks = taskContainer.querySelectorAll('.task-entry');
                    
                    const newIndex = tasks.length;
                    const newTask = document.createElement('div');
                    newTask.className = 'task-entry';
                    newTask.setAttribute('data-task-index', newIndex);
                    newTask.innerHTML = `
                        <div class="form-group">
                            <label>Task*</label>
                            <input type="text" name="tasks[${dayIndex}][]" placeholder="Enter task" required>
                        </div>
                        <div class="form-group">
                            <label>Client Name*</label>
                            <input type="text" name="clientNames[${dayIndex}][]" placeholder="Enter client name" required>
                        </div>
                        <div class="form-group">
                            <label>Time (Hours)*</label>
                            <input type="number" name="times[${dayIndex}][]" step="0.01" min="0" placeholder="e.g., 1.25" required>
                        </div>
                        <button type="button" onclick="removeSprintTask(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">Remove</button>
                    `;
                    taskContainer.appendChild(newTask);
                }
            });
        });
        
        function removeSprintTask(button) {
            const taskEntry = button.closest('.task-entry');
            if (taskEntry) {
                taskEntry.remove();
            }
        }
        
        function removeSprintDay(button) {
            const dayEntry = button.closest('.day-entry');
            if (dayEntry) {
                dayEntry.remove();
            }
        }
        
        function handleSprintPlanSubmit(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            const formData = new FormData(event.target);
            
            fetch('/submit_sprint_plan', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                if (data.success) {
                    alert('Sprint plan submitted successfully!');
                    closeSprintPlanModal();
                    
                    const sprintCard = document.getElementById('sprintPlanCard');
                    if (sprintCard) {
                        sprintCard.classList.add('sprint-plan-submitted');
                        sprintCard.style.cursor = 'not-allowed';
                        sprintCard.style.opacity = '0.6';
                        sprintCard.onclick = null;
                        
                        const icon = sprintCard.querySelector('i');
                        const heading = sprintCard.querySelector('h3');
                        if (icon) icon.style.opacity = '0.5';
                        if (heading) {
                            heading.textContent = 'Sprint Plan Submitted';
                            heading.style.color = '#888';
                        }
                    }
                    
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert(data.error || 'Failed to submit sprint plan');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        }
        
        // Last Week Sprint Modal Functions
        function openLastWeekSprintModal() {
            const sprintCard = document.getElementById('lastWeekSprintCard');
            if (sprintCard && sprintCard.classList.contains('last-week-sprint-submitted')) {
                return;
            }
            document.getElementById('lastWeekSprintModal').style.display = 'block';
        }
        
        function closeLastWeekSprintModal() {
            document.getElementById('lastWeekSprintModal').style.display = 'none';
            const form = document.getElementById('lastWeekSprintForm');
            if (form) {
                form.reset();
                const dayContainer = document.getElementById('lastWeekSprintDayContainer');
                if (dayContainer) {
                    const firstDay = dayContainer.querySelector('.day-entry');
                    dayContainer.innerHTML = '';
                    if (firstDay) {
                        dayContainer.appendChild(firstDay.cloneNode(true));
                    }
                }
            }
        }
        
        // Last Week Sprint JavaScript
        let lastWeekSprintDayIndex = 0;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Add New Day functionality for Last Week Sprint
            const addLastWeekDayBtn = document.getElementById('addLastWeekSprintDayBtn');
            if (addLastWeekDayBtn) {
                addLastWeekDayBtn.addEventListener('click', function() {
                    const dayContainer = document.getElementById('lastWeekSprintDayContainer');
                    const days = dayContainer.querySelectorAll('.day-entry');
                    
                    if (days.length >= 6) {
                        alert('Maximum 6 days allowed');
                        return;
                    }
                    
                    lastWeekSprintDayIndex++;
                    const newDay = document.createElement('div');
                    newDay.className = 'day-entry';
                    newDay.setAttribute('data-day-index', lastWeekSprintDayIndex);
                    newDay.innerHTML = `
                        <hr style="margin: 20px 0; border: none; border-top: 2px solid #ddd;">
                        <div class="form-group">
                            <label>Date*</label>
                            <input type="date" class="sprint-date-input" name="dates[]" required>
                        </div>
                        
                        <div class="form-group">
                            <h4 style="margin-bottom: 10px;">Tasks</h4>
                            <div id="lastWeekSprintDay${lastWeekSprintDayIndex}TaskContainer" class="task-container">
                                <div class="task-entry" data-task-index="0">
                                    <div class="form-group">
                                        <label>Task*</label>
                                        <input type="text" name="tasks[${lastWeekSprintDayIndex}][]" placeholder="Enter task" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Client Name*</label>
                                        <input type="text" name="clientNames[${lastWeekSprintDayIndex}][]" placeholder="Enter client name" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Time (Hours)*</label>
                                        <input type="number" name="times[${lastWeekSprintDayIndex}][]" step="0.01" min="0" placeholder="e.g., 1.25" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Status*</label>
                                        <select name="statuses[${lastWeekSprintDayIndex}][]" required>
                                            <option value="">Select Status</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Pending">Pending</option>
                                            <option value="In Progress">In Progress</option>
                                            <option value="Remove">Remove</option>
                                            <option value="Take over">Take over</option>
                                        </select>
                                    </div>
                                    <button type="button" onclick="removeLastWeekSprintTask(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">Remove</button>
                                </div>
                            </div>
                            <button type="button" class="add-member-btn add-lastweek-task-btn" data-day="${lastWeekSprintDayIndex}" style="margin-top: 10px;">+ Add New Task</button>
                        </div>
                        
                        <button type="button" onclick="removeLastWeekSprintDay(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 10px; margin-top: 15px; cursor: pointer; width: 100%;">Remove This Day</button>
                    `;
                    dayContainer.appendChild(newDay);
                });
            }
            
            // Add New Task functionality for Last Week Sprint (delegated)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('add-lastweek-task-btn')) {
                    const dayIndex = e.target.getAttribute('data-day');
                    const taskContainer = document.getElementById(`lastWeekSprintDay${dayIndex}TaskContainer`);
                    const tasks = taskContainer.querySelectorAll('.task-entry');
                    
                    const newIndex = tasks.length;
                    const newTask = document.createElement('div');
                    newTask.className = 'task-entry';
                    newTask.setAttribute('data-task-index', newIndex);
                    newTask.innerHTML = `
                        <div class="form-group">
                            <label>Task*</label>
                            <input type="text" name="tasks[${dayIndex}][]" placeholder="Enter task" required>
                        </div>
                        <div class="form-group">
                            <label>Client Name*</label>
                            <input type="text" name="clientNames[${dayIndex}][]" placeholder="Enter client name" required>
                        </div>
                        <div class="form-group">
                            <label>Time (Hours)*</label>
                            <input type="number" name="times[${dayIndex}][]" step="0.01" min="0" placeholder="e.g., 1.25" required>
                        </div>
                        <div class="form-group">
                            <label>Status*</label>
                            <select name="statuses[${dayIndex}][]" required>
                                <option value="">Select Status</option>
                                <option value="Completed">Completed</option>
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Remove">Remove</option>
                                <option value="Take over">Take over</option>
                            </select>
                        </div>
                        <button type="button" onclick="removeLastWeekSprintTask(this)" style="background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">Remove</button>
                    `;
                    taskContainer.appendChild(newTask);
                }
            });
        });
        
        function removeLastWeekSprintTask(button) {
            const taskEntry = button.closest('.task-entry');
            if (taskEntry) {
                taskEntry.remove();
            }
        }
        
        function removeLastWeekSprintDay(button) {
            const dayEntry = button.closest('.day-entry');
            if (dayEntry) {
                dayEntry.remove();
            }
        }
        
        function handleLastWeekSprintSubmit(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            const formData = new FormData(event.target);
            
            fetch('/submit_last_week_sprint', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                if (data.success) {
                    alert('Last week sprint submitted successfully!');
                    closeLastWeekSprintModal();
                    
                    const sprintCard = document.getElementById('lastWeekSprintCard');
                    if (sprintCard) {
                        sprintCard.classList.add('last-week-sprint-submitted');
                        sprintCard.style.cursor = 'not-allowed';
                        sprintCard.style.opacity = '0.6';
                        sprintCard.onclick = null;
                        
                        const icon = sprintCard.querySelector('i');
                        const heading = sprintCard.querySelector('h3');
                        if (icon) icon.style.opacity = '0.5';
                        if (heading) {
                            heading.textContent = 'Last Week Sprint Submitted';
                            heading.style.color = '#888';
                        }
                    }
                    
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert(data.error || 'Failed to submit last week sprint');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        }
        
        // Extra Work Modal Functions
        function openExtraWorkModal() {
            const today = new Date();
            today.setDate(today.getDate() - 1);
            const yesterday = today.toISOString().split('T')[0];
            document.getElementById('extraWorkDate').value = yesterday;
            document.getElementById('extraWorkModal').style.display = 'block';
        }
        
        function closeExtraWorkModal() {
            document.getElementById('extraWorkModal').style.display = 'none';
            const form = document.getElementById('extraWorkForm');
            if (form) {
                form.reset();
            }
        }
        
        function handleExtraWorkSubmit(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            const formData = new FormData(event.target);
            
            fetch('/submit_extra_work', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                if (data.success) {
                    alert('Extra work submitted successfully!');
                    closeExtraWorkModal();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert(data.error || 'Failed to submit extra work');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        }
        
        // Leave Approval Modal Functions
        function openLeaveApprovalModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('leaveRequestDate').value = today;
            document.getElementById('leaveApprovalModal').style.display = 'block';
        }
        
        function closeLeaveApprovalModal() {
            document.getElementById('leaveApprovalModal').style.display = 'none';
            const form = document.getElementById('leaveApprovalForm');
            if (form) {
                form.reset();
                document.getElementById('currentTaskField').style.display = 'none';
            }
        }
        
        function toggleCurrentTaskField() {
            const leaveType = document.querySelector('input[name="leaveType"]:checked').value;
            const currentTaskField = document.getElementById('currentTaskField');
            const currentTaskInput = document.getElementById('leaveCurrentTask');
            
            if (leaveType === 'Emergency Leave') {
                currentTaskField.style.display = 'block';
                currentTaskInput.required = true;
            } else {
                currentTaskField.style.display = 'none';
                currentTaskInput.required = false;
                currentTaskInput.value = '';
            }
        }
        
        function handleLeaveApprovalSubmit() {
            const form = document.getElementById('leaveApprovalForm');
            const leaveType = document.querySelector('input[name="leaveType"]:checked').value;
            
            if (leaveType === 'Emergency Leave') {
                const currentTask = document.getElementById('leaveCurrentTask').value.trim();
                if (!currentTask) {
                    alert('Please enter your current task for Emergency Leave');
                    return;
                }
            }
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            alert('Leave approval request submitted successfully!');
            closeLeaveApprovalModal();
        }
        
        // Complaint Modal Functions
        function openComplaintModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('complaintDate').value = today;
            document.getElementById('complaintModal').style.display = 'block';
        }
        
        function closeComplaintModal() {
            document.getElementById('complaintModal').style.display = 'none';
            const form = document.getElementById('complaintForm');
            if (form) {
                form.reset();
            }
        }
        
        function handleComplaintSubmit() {
            const form = document.getElementById('complaintForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            alert('Complaint submitted successfully!');
            closeComplaintModal();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        }

        // Handle Create ID form submission with OTP authentication
        let otpTimerInterval = null;
        let otpTimeRemaining = 180; // 3 minutes in seconds
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function startOtpTimer() {
            // Clear any existing timer
            if (otpTimerInterval) {
                clearInterval(otpTimerInterval);
            }
            
            otpTimeRemaining = 180; // Reset to 3 minutes
            const timerElement = document.getElementById('otpTimer');
            
            // Update timer immediately
            timerElement.textContent = `(Time remaining: ${formatTime(otpTimeRemaining)})`;
            timerElement.style.color = '#e74c3c';
            
            // Update timer every second
            otpTimerInterval = setInterval(function() {
                otpTimeRemaining--;
                
                if (otpTimeRemaining > 0) {
                    timerElement.textContent = `(Time remaining: ${formatTime(otpTimeRemaining)})`;
                    if (otpTimeRemaining <= 30) {
                        timerElement.style.color = '#e74c3c'; // Red when less than 30 seconds
                    } else {
                        timerElement.style.color = '#27ae60'; // Green otherwise
                    }
                } else {
                    // Timer expired
                    clearInterval(otpTimerInterval);
                    otpTimerInterval = null;
                    timerElement.textContent = '(OTP Expired)';
                    timerElement.style.color = '#e74c3c';
                    document.getElementById('otpInput').disabled = true;
                    document.getElementById('verifyOtpBtn').disabled = true;
                    document.getElementById('otpVerifyStatus').textContent = 'OTP has expired. Please request a new OTP.';
                    document.getElementById('otpVerifyStatus').style.color = '#e74c3c';
                    document.getElementById('otpVerifyStatus').style.display = 'block';
                }
            }, 1000);
        }
        
        function stopOtpTimer() {
            if (otpTimerInterval) {
                clearInterval(otpTimerInterval);
                otpTimerInterval = null;
            }
            const timerElement = document.getElementById('otpTimer');
            if (timerElement) {
                timerElement.textContent = '';
            }
        }
        
        const createIdForm = document.getElementById('createIdForm');
        if (createIdForm) {
            // Request OTP button handler
            const requestOtpBtn = document.getElementById('requestOtpBtn');
            if (requestOtpBtn) {
                requestOtpBtn.addEventListener('click', function() {
                    requestOtpBtn.disabled = true;
                    requestOtpBtn.textContent = 'Sending OTP...';
                    
                    fetch('/request_create_id_otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('otpRequestStatus').textContent = 'OTP sent successfully! Please check the authorized email.';
                            document.getElementById('otpRequestStatus').style.display = 'block';
                            document.getElementById('otpRequestStatus').style.color = '#27ae60';
                            document.getElementById('otpVerificationSection').style.display = 'block';
                            requestOtpBtn.style.display = 'none';
                            // Start the countdown timer
                            startOtpTimer();
                        } else {
                            document.getElementById('otpRequestStatus').textContent = data.message || 'Failed to send OTP. Please try again.';
                            document.getElementById('otpRequestStatus').style.display = 'block';
                            document.getElementById('otpRequestStatus').style.color = '#e74c3c';
                            requestOtpBtn.disabled = false;
                            requestOtpBtn.textContent = 'Request OTP';
                        }
                    })
                    .catch(error => {
                        console.error('Error requesting OTP:', error);
                        document.getElementById('otpRequestStatus').textContent = 'Error requesting OTP. Please try again.';
                        document.getElementById('otpRequestStatus').style.display = 'block';
                        document.getElementById('otpRequestStatus').style.color = '#e74c3c';
                        requestOtpBtn.disabled = false;
                        requestOtpBtn.textContent = 'Request OTP';
                    });
                });
            }
            
            // Verify OTP button handler
            const verifyOtpBtn = document.getElementById('verifyOtpBtn');
            if (verifyOtpBtn) {
                verifyOtpBtn.addEventListener('click', function() {
                    const otpInput = document.getElementById('otpInput');
                    const otpValue = otpInput.value.trim();
                    
                    if (!otpValue) {
                        document.getElementById('otpVerifyStatus').textContent = 'Please enter the OTP.';
                        document.getElementById('otpVerifyStatus').style.color = '#e74c3c';
                        document.getElementById('otpVerifyStatus').style.display = 'block';
                        return;
                    }
                    
                    verifyOtpBtn.disabled = true;
                    verifyOtpBtn.textContent = 'Verifying...';
                    
                    const formData = new FormData();
                    formData.append('otp', otpValue);
                    
                    fetch('/verify_create_id_otp', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Stop the timer when OTP is verified
                            stopOtpTimer();
                            document.getElementById('otpTimer').textContent = '(OTP Verified)';
                            document.getElementById('otpTimer').style.color = '#27ae60';
                            
                            document.getElementById('otpVerifyStatus').textContent = 'OTP verified successfully! You can now create the ID.';
                            document.getElementById('otpVerifyStatus').style.color = '#27ae60';
                            document.getElementById('otpVerifyStatus').style.display = 'block';
                            document.getElementById('createIdSubmitBtn').disabled = false;
                            document.getElementById('createIdSubmitBtn').style.opacity = '1';
                            document.getElementById('createIdSubmitBtn').style.cursor = 'pointer';
                            otpInput.disabled = true;
                            verifyOtpBtn.disabled = true;
                            verifyOtpBtn.textContent = 'OTP Verified';
                            verifyOtpBtn.style.backgroundColor = '#27ae60';
                        } else {
                            document.getElementById('otpVerifyStatus').textContent = data.message || 'Invalid OTP. Please try again.';
                            document.getElementById('otpVerifyStatus').style.color = '#e74c3c';
                            document.getElementById('otpVerifyStatus').style.display = 'block';
                            verifyOtpBtn.disabled = false;
                            verifyOtpBtn.textContent = 'Verify OTP';
                            otpInput.value = '';
                            otpInput.focus();
                        }
                    })
                    .catch(error => {
                        console.error('Error verifying OTP:', error);
                        document.getElementById('otpVerifyStatus').textContent = 'Error verifying OTP. Please try again.';
                        document.getElementById('otpVerifyStatus').style.color = '#e74c3c';
                        document.getElementById('otpVerifyStatus').style.display = 'block';
                        verifyOtpBtn.disabled = false;
                        verifyOtpBtn.textContent = 'Verify OTP';
                    });
                });
            }
            
            // Form submission handler - check OTP verification
            createIdForm.addEventListener('submit', function(e) {
                const createIdSubmitBtn = document.getElementById('createIdSubmitBtn');
                if (createIdSubmitBtn && createIdSubmitBtn.disabled) {
                    e.preventDefault();
                    alert('Please verify OTP first before creating the ID.');
                    return false;
                }
                
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating ID...';
                }
                // Let the form submit normally if OTP is verified
            });
        }
        
        // Reset OTP section when modal is closed
        function closeCreateIdModal() {
            // Stop the timer
            stopOtpTimer();
            
            closeModal('createIdModal');
            // Reset OTP section
            const createIdForm = document.getElementById('createIdForm');
            if (createIdForm) {
                createIdForm.reset();
                document.getElementById('otpRequestSection').style.display = 'block';
                document.getElementById('otpVerificationSection').style.display = 'none';
                document.getElementById('otpRequestStatus').style.display = 'none';
                document.getElementById('otpVerifyStatus').style.display = 'none';
                document.getElementById('requestOtpBtn').style.display = 'block';
                document.getElementById('requestOtpBtn').disabled = false;
                document.getElementById('requestOtpBtn').textContent = 'Request OTP';
                document.getElementById('verifyOtpBtn').disabled = false;
                document.getElementById('verifyOtpBtn').textContent = 'Verify OTP';
                document.getElementById('verifyOtpBtn').style.backgroundColor = '#27ae60';
                document.getElementById('otpInput').disabled = false;
                document.getElementById('createIdSubmitBtn').disabled = true;
                document.getElementById('createIdSubmitBtn').style.opacity = '0.6';
                document.getElementById('createIdSubmitBtn').style.cursor = 'not-allowed';
                document.getElementById('createIdSubmitBtn').textContent = 'Create ID';
                // Reset timer display
                document.getElementById('otpTimer').textContent = '';
            }
        }

        // Update ID Modal Functions
        let currentUpdateUserId = null;

        function openUpdateIdModal() {
            openModal('updateIdModal');
            loadEmployeeList();
            // Reset OTP section when opening modal
            stopUpdateOtpTimer();
            document.getElementById('updateOtpRequestSection').style.display = 'block';
            document.getElementById('updateOtpVerificationSection').style.display = 'none';
            document.getElementById('updateOtpRequestStatus').style.display = 'none';
            document.getElementById('updateOtpVerifyStatus').style.display = 'none';
            document.getElementById('updateRequestOtpBtn').style.display = 'block';
            document.getElementById('updateRequestOtpBtn').disabled = false;
            document.getElementById('updateRequestOtpBtn').textContent = 'Request OTP';
            document.getElementById('updateVerifyOtpBtn').disabled = false;
            document.getElementById('updateVerifyOtpBtn').textContent = 'Verify OTP';
            document.getElementById('updateVerifyOtpBtn').style.backgroundColor = '#27ae60';
            if (document.getElementById('updateOtpInput')) {
                document.getElementById('updateOtpInput').disabled = false;
                document.getElementById('updateOtpInput').value = '';
            }
            if (document.getElementById('updateAllFieldsBtn')) {
                document.getElementById('updateAllFieldsBtn').disabled = true;
                document.getElementById('updateAllFieldsBtn').style.opacity = '0.6';
                document.getElementById('updateAllFieldsBtn').style.cursor = 'not-allowed';
                document.getElementById('updateAllFieldsBtn').textContent = 'Submit All Changes';
            }
            if (document.getElementById('updateOtpTimer')) {
                document.getElementById('updateOtpTimer').textContent = '';
            }
            // Disable all update field buttons
            document.querySelectorAll('.update-field-btn').forEach(btn => {
                btn.disabled = true;
            });
        }
        
        function closeUpdateIdModal() {
            // Stop the timer
            stopUpdateOtpTimer();
            
            closeModal('updateIdModal');
            resetUpdateForm();
        }

        function openDeleteIdModal() {
            openModal('deleteIdModal');
            loadDeleteEmployeeList();
            // Reset OTP section when opening modal
            stopDeleteOtpTimer();
            document.getElementById('deleteOtpRequestSection').style.display = 'block';
            document.getElementById('deleteOtpVerificationSection').style.display = 'none';
            document.getElementById('deleteOtpRequestStatus').style.display = 'none';
            document.getElementById('deleteOtpVerifyStatus').style.display = 'none';
            document.getElementById('deleteRequestOtpBtn').style.display = 'block';
            document.getElementById('deleteRequestOtpBtn').disabled = false;
            document.getElementById('deleteRequestOtpBtn').textContent = 'Request OTP';
            document.getElementById('deleteVerifyOtpBtn').disabled = false;
            document.getElementById('deleteVerifyOtpBtn').textContent = 'Verify OTP';
            document.getElementById('deleteVerifyOtpBtn').style.backgroundColor = '#27ae60';
            if (document.getElementById('deleteOtpInput')) {
                document.getElementById('deleteOtpInput').disabled = false;
                document.getElementById('deleteOtpInput').value = '';
            }
            if (document.getElementById('deleteIdBtn')) {
                document.getElementById('deleteIdBtn').disabled = true;
                document.getElementById('deleteIdBtn').style.opacity = '0.6';
                document.getElementById('deleteIdBtn').style.cursor = 'not-allowed';
                document.getElementById('deleteIdBtn').textContent = 'Delete ID';
            }
            if (document.getElementById('deleteOtpTimer')) {
                document.getElementById('deleteOtpTimer').textContent = '';
            }
        }
        
        function closeDeleteIdModal() {
            // Stop the timer
            stopDeleteOtpTimer();
            
            closeModal('deleteIdModal');
            
            // Reset OTP section
            document.getElementById('deleteOtpRequestSection').style.display = 'block';
            document.getElementById('deleteOtpVerificationSection').style.display = 'none';
            document.getElementById('deleteOtpRequestStatus').style.display = 'none';
            document.getElementById('deleteOtpVerifyStatus').style.display = 'none';
            document.getElementById('deleteRequestOtpBtn').style.display = 'block';
            document.getElementById('deleteRequestOtpBtn').disabled = false;
            document.getElementById('deleteRequestOtpBtn').textContent = 'Request OTP';
            document.getElementById('deleteVerifyOtpBtn').disabled = false;
            document.getElementById('deleteVerifyOtpBtn').textContent = 'Verify OTP';
            document.getElementById('deleteVerifyOtpBtn').style.backgroundColor = '#27ae60';
            if (document.getElementById('deleteOtpInput')) {
                document.getElementById('deleteOtpInput').disabled = false;
                document.getElementById('deleteOtpInput').value = '';
            }
            if (document.getElementById('deleteIdBtn')) {
                document.getElementById('deleteIdBtn').disabled = true;
                document.getElementById('deleteIdBtn').style.opacity = '0.6';
                document.getElementById('deleteIdBtn').style.cursor = 'not-allowed';
                document.getElementById('deleteIdBtn').textContent = 'Delete ID';
            }
            if (document.getElementById('deleteOtpTimer')) {
                document.getElementById('deleteOtpTimer').textContent = '';
            }
            if (document.getElementById('deleteEmployeeSelect')) {
                document.getElementById('deleteEmployeeSelect').value = '';
            }
        }

        function loadEmployeeList() {
            fetch('/api/get_users_list')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('employeeSelect');
                    select.innerHTML = '<option value="">Select Employee</option>';
                    
                    if (data.success && data.users) {
                        data.users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.employee_name;
                            select.appendChild(option);
                        });
                    } else {
                        select.innerHTML = '<option value="">No employees found</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading employees:', error);
                    document.getElementById('employeeSelect').innerHTML = '<option value="">Error loading employees</option>';
                });
        }

        function loadEmployeeDetails() {
            const userId = document.getElementById('employeeSelect').value;
            if (!userId) {
                alert('Please select an employee first');
                return;
            }

            fetch(`/api/get_user_details/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentUpdateUserId = userId;
                        document.getElementById('update_user_id').value = userId;
                        
                        // Populate form fields
                        document.getElementById('update_employee_name').value = data.user.employee_name || '';
                        document.getElementById('update_username').value = data.user.username || '';
                        document.getElementById('update_password').value = ''; // Don't show password
                        document.getElementById('update_designation').value = data.employee_data.position || '';
                        document.getElementById('update_department').value = data.user.department || '';
                        document.getElementById('update_experience').value = data.employee_data.experience || '';
                        document.getElementById('update_education').value = data.employee_data.education || '';
                        document.getElementById('update_certifications').value = data.employee_data.certifications || '';
                        document.getElementById('update_date_of_birth').value = data.employee_data.date_of_birth || '';
                        document.getElementById('update_blood_group').value = data.employee_data.blood_group || '';
                        document.getElementById('update_email').value = data.user.email || '';
                        document.getElementById('update_contact').value = data.employee_data.contact_number || '';
                        document.getElementById('update_browser_fingerprint').value = data.employee_data.browser_fingerprint || '';

                        // Show edit form, hide select form
                        document.getElementById('selectEmployeeStep').style.display = 'none';
                        document.getElementById('editEmployeeStep').style.display = 'block';
                        
                        // Reset OTP section when loading new employee
                        stopUpdateOtpTimer();
                        document.getElementById('updateOtpRequestSection').style.display = 'block';
                        document.getElementById('updateOtpVerificationSection').style.display = 'none';
                        document.getElementById('updateOtpRequestStatus').style.display = 'none';
                        document.getElementById('updateOtpVerifyStatus').style.display = 'none';
                        document.getElementById('updateRequestOtpBtn').style.display = 'block';
                        document.getElementById('updateRequestOtpBtn').disabled = false;
                        document.getElementById('updateRequestOtpBtn').textContent = 'Request OTP';
                        document.getElementById('updateVerifyOtpBtn').disabled = false;
                        document.getElementById('updateVerifyOtpBtn').textContent = 'Verify OTP';
                        document.getElementById('updateVerifyOtpBtn').style.backgroundColor = '#27ae60';
                        document.getElementById('updateOtpInput').disabled = false;
                        document.getElementById('updateOtpInput').value = '';
                        document.getElementById('updateAllFieldsBtn').disabled = true;
                        document.getElementById('updateAllFieldsBtn').style.opacity = '0.6';
                        document.getElementById('updateAllFieldsBtn').style.cursor = 'not-allowed';
                        document.getElementById('updateAllFieldsBtn').textContent = 'Submit All Changes';
                        document.getElementById('updateOtpTimer').textContent = '';
                        
                        // Disable all update field buttons until OTP is verified
                        document.querySelectorAll('.update-field-btn').forEach(btn => {
                            btn.disabled = true;
                        });
                    } else {
                        alert('Error loading employee details: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error loading employee details:', error);
                    alert('Error loading employee details. Please try again.');
                });
        }

        // Update ID OTP Timer Functions
        let updateOtpTimerInterval = null;
        let updateOtpTimeRemaining = 180; // 3 minutes in seconds
        
        function formatUpdateTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function startUpdateOtpTimer() {
            // Clear any existing timer
            if (updateOtpTimerInterval) {
                clearInterval(updateOtpTimerInterval);
            }
            
            updateOtpTimeRemaining = 180; // Reset to 3 minutes
            const timerElement = document.getElementById('updateOtpTimer');
            
            // Update timer immediately
            timerElement.textContent = `(Time remaining: ${formatUpdateTime(updateOtpTimeRemaining)})`;
            timerElement.style.color = '#e74c3c';
            
            // Update timer every second
            updateOtpTimerInterval = setInterval(function() {
                updateOtpTimeRemaining--;
                
                if (updateOtpTimeRemaining > 0) {
                    timerElement.textContent = `(Time remaining: ${formatUpdateTime(updateOtpTimeRemaining)})`;
                    if (updateOtpTimeRemaining <= 30) {
                        timerElement.style.color = '#e74c3c'; // Red when less than 30 seconds
                    } else {
                        timerElement.style.color = '#27ae60'; // Green otherwise
                    }
                } else {
                    // Timer expired
                    clearInterval(updateOtpTimerInterval);
                    updateOtpTimerInterval = null;
                    timerElement.textContent = '(OTP Expired)';
                    timerElement.style.color = '#e74c3c';
                    document.getElementById('updateOtpInput').disabled = true;
                    document.getElementById('updateVerifyOtpBtn').disabled = true;
                    document.getElementById('updateOtpVerifyStatus').textContent = 'OTP has expired. Please request a new OTP.';
                    document.getElementById('updateOtpVerifyStatus').style.color = '#e74c3c';
                    document.getElementById('updateOtpVerifyStatus').style.display = 'block';
                }
            }, 1000);
        }
        
        function stopUpdateOtpTimer() {
            if (updateOtpTimerInterval) {
                clearInterval(updateOtpTimerInterval);
                updateOtpTimerInterval = null;
            }
            const timerElement = document.getElementById('updateOtpTimer');
            if (timerElement) {
                timerElement.textContent = '';
            }
        }
        
        // Update ID OTP Handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Request OTP button handler for Update ID
            const updateRequestOtpBtn = document.getElementById('updateRequestOtpBtn');
            if (updateRequestOtpBtn) {
                updateRequestOtpBtn.addEventListener('click', function() {
                    updateRequestOtpBtn.disabled = true;
                    updateRequestOtpBtn.textContent = 'Sending OTP...';
                    
                    fetch('/request_update_id_otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('updateOtpRequestStatus').textContent = 'OTP sent successfully! Please check the authorized email.';
                            document.getElementById('updateOtpRequestStatus').style.display = 'block';
                            document.getElementById('updateOtpRequestStatus').style.color = '#27ae60';
                            document.getElementById('updateOtpVerificationSection').style.display = 'block';
                            updateRequestOtpBtn.style.display = 'none';
                            // Start the countdown timer
                            startUpdateOtpTimer();
                        } else {
                            document.getElementById('updateOtpRequestStatus').textContent = data.message || 'Failed to send OTP. Please try again.';
                            document.getElementById('updateOtpRequestStatus').style.display = 'block';
                            document.getElementById('updateOtpRequestStatus').style.color = '#e74c3c';
                            updateRequestOtpBtn.disabled = false;
                            updateRequestOtpBtn.textContent = 'Request OTP';
                        }
                    })
                    .catch(error => {
                        console.error('Error requesting OTP:', error);
                        document.getElementById('updateOtpRequestStatus').textContent = 'Error requesting OTP. Please try again.';
                        document.getElementById('updateOtpRequestStatus').style.display = 'block';
                        document.getElementById('updateOtpRequestStatus').style.color = '#e74c3c';
                        updateRequestOtpBtn.disabled = false;
                        updateRequestOtpBtn.textContent = 'Request OTP';
                    });
                });
            }
            
            // Verify OTP button handler for Update ID
            const updateVerifyOtpBtn = document.getElementById('updateVerifyOtpBtn');
            if (updateVerifyOtpBtn) {
                updateVerifyOtpBtn.addEventListener('click', function() {
                    const otpInput = document.getElementById('updateOtpInput');
                    const otpValue = otpInput.value.trim();
                    
                    if (!otpValue) {
                        document.getElementById('updateOtpVerifyStatus').textContent = 'Please enter the OTP.';
                        document.getElementById('updateOtpVerifyStatus').style.color = '#e74c3c';
                        document.getElementById('updateOtpVerifyStatus').style.display = 'block';
                        return;
                    }
                    
                    updateVerifyOtpBtn.disabled = true;
                    updateVerifyOtpBtn.textContent = 'Verifying...';
                    
                    const formData = new FormData();
                    formData.append('otp', otpValue);
                    
                    fetch('/verify_update_id_otp', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Stop the timer when OTP is verified
                            stopUpdateOtpTimer();
                            document.getElementById('updateOtpTimer').textContent = '(OTP Verified)';
                            document.getElementById('updateOtpTimer').style.color = '#27ae60';
                            
                            document.getElementById('updateOtpVerifyStatus').textContent = 'OTP verified successfully! You can now update employee details.';
                            document.getElementById('updateOtpVerifyStatus').style.color = '#27ae60';
                            document.getElementById('updateOtpVerifyStatus').style.display = 'block';
                            document.getElementById('updateAllFieldsBtn').disabled = false;
                            document.getElementById('updateAllFieldsBtn').style.opacity = '1';
                            document.getElementById('updateAllFieldsBtn').style.cursor = 'pointer';
                            otpInput.disabled = true;
                            updateVerifyOtpBtn.disabled = true;
                            updateVerifyOtpBtn.textContent = 'OTP Verified';
                            updateVerifyOtpBtn.style.backgroundColor = '#27ae60';
                            
                            // Enable all update field buttons
                            document.querySelectorAll('.update-field-btn').forEach(btn => {
                                btn.disabled = false;
                            });
                        } else {
                            document.getElementById('updateOtpVerifyStatus').textContent = data.message || 'Invalid OTP. Please try again.';
                            document.getElementById('updateOtpVerifyStatus').style.color = '#e74c3c';
                            document.getElementById('updateOtpVerifyStatus').style.display = 'block';
                            updateVerifyOtpBtn.disabled = false;
                            updateVerifyOtpBtn.textContent = 'Verify OTP';
                            otpInput.value = '';
                            otpInput.focus();
                        }
                    })
                    .catch(error => {
                        console.error('Error verifying OTP:', error);
                        document.getElementById('updateOtpVerifyStatus').textContent = 'Error verifying OTP. Please try again.';
                        document.getElementById('updateOtpVerifyStatus').style.color = '#e74c3c';
                        document.getElementById('updateOtpVerifyStatus').style.display = 'block';
                        updateVerifyOtpBtn.disabled = false;
                        updateVerifyOtpBtn.textContent = 'Verify OTP';
                    });
                });
            }
        });
        
        function updateField(fieldName) {
            if (!currentUpdateUserId) {
                alert('Please select an employee first');
                return;
            }
            
            // Check if OTP is verified (check if updateAllFieldsBtn is enabled)
            const updateAllFieldsBtn = document.getElementById('updateAllFieldsBtn');
            if (updateAllFieldsBtn && updateAllFieldsBtn.disabled) {
                alert('Please verify OTP first before updating any field.');
                return;
            }

            const fieldValue = document.getElementById(`update_${fieldName}`).value;
            if (!fieldValue && fieldName !== 'password') {
                alert('Please enter a value for this field');
                return;
            }

            const updateData = {
                user_id: currentUpdateUserId,
                field: fieldName,
                value: fieldValue
            };

            fetch('/api/update_user_field', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Field updated successfully!');
                } else {
                    alert('Error updating field: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error updating field:', error);
                alert('Error updating field. Please try again.');
            });
        }

        function updateAllFields() {
            if (!currentUpdateUserId) {
                alert('Please select an employee first');
                return;
            }
            
            // Check if OTP is verified
            const updateAllFieldsBtn = document.getElementById('updateAllFieldsBtn');
            if (updateAllFieldsBtn && updateAllFieldsBtn.disabled) {
                alert('Please verify OTP first before updating employee details.');
                return;
            }

            const formData = {
                user_id: currentUpdateUserId,
                employee_name: document.getElementById('update_employee_name').value,
                username: document.getElementById('update_username').value,
                password: document.getElementById('update_password').value,
                designation: document.getElementById('update_designation').value,
                department: document.getElementById('update_department').value,
                experience: document.getElementById('update_experience').value,
                education: document.getElementById('update_education').value,
                certifications: document.getElementById('update_certifications').value,
                date_of_birth: document.getElementById('update_date_of_birth').value,
                blood_group: document.getElementById('update_blood_group').value,
                email: document.getElementById('update_email').value,
                contact: document.getElementById('update_contact').value,
                browser_fingerprint: document.getElementById('update_browser_fingerprint').value
            };

            // Validate required fields
            const requiredFields = ['employee_name', 'username', 'designation', 'department', 'email'];
            for (let field of requiredFields) {
                if (!formData[field]) {
                    alert(`Please fill in the ${field.replace('_', ' ')} field`);
                    return;
                }
            }

            updateAllFieldsBtn.disabled = true;
            updateAllFieldsBtn.textContent = 'Updating...';

            fetch('/api/update_user_all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('All fields updated successfully!');
                    resetUpdateForm();
                } else {
                    alert('Error updating fields: ' + (data.message || 'Unknown error'));
                    updateAllFieldsBtn.disabled = false;
                    updateAllFieldsBtn.textContent = 'Submit All Changes';
                }
            })
            .catch(error => {
                console.error('Error updating fields:', error);
                alert('Error updating fields. Please try again.');
                updateAllFieldsBtn.disabled = false;
                updateAllFieldsBtn.textContent = 'Submit All Changes';
            });
        }

        function resetUpdateForm() {
            // Stop the timer
            stopUpdateOtpTimer();
            
            document.getElementById('selectEmployeeStep').style.display = 'block';
            document.getElementById('editEmployeeStep').style.display = 'none';
            document.getElementById('employeeSelect').value = '';
            currentUpdateUserId = null;
            document.getElementById('updateIdForm').reset();
            
            // Reset OTP section
            document.getElementById('updateOtpRequestSection').style.display = 'block';
            document.getElementById('updateOtpVerificationSection').style.display = 'none';
            document.getElementById('updateOtpRequestStatus').style.display = 'none';
            document.getElementById('updateOtpVerifyStatus').style.display = 'none';
            document.getElementById('updateRequestOtpBtn').style.display = 'block';
            document.getElementById('updateRequestOtpBtn').disabled = false;
            document.getElementById('updateRequestOtpBtn').textContent = 'Request OTP';
            document.getElementById('updateVerifyOtpBtn').disabled = false;
            document.getElementById('updateVerifyOtpBtn').textContent = 'Verify OTP';
            document.getElementById('updateVerifyOtpBtn').style.backgroundColor = '#27ae60';
            document.getElementById('updateOtpInput').disabled = false;
            document.getElementById('updateAllFieldsBtn').disabled = true;
            document.getElementById('updateAllFieldsBtn').style.opacity = '0.6';
            document.getElementById('updateAllFieldsBtn').style.cursor = 'not-allowed';
            document.getElementById('updateAllFieldsBtn').textContent = 'Submit All Changes';
            document.getElementById('updateOtpTimer').textContent = '';
            
            // Disable all update field buttons
            document.querySelectorAll('.update-field-btn').forEach(btn => {
                btn.disabled = true;
            });
        }

        function loadDeleteEmployeeList() {
            fetch('/api/get_users_list')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('deleteEmployeeSelect');
                    select.innerHTML = '<option value="">Select Employee</option>';
                    
                    if (data.success && data.users) {
                        data.users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = user.employee_name;
                            select.appendChild(option);
                        });
                    } else {
                        select.innerHTML = '<option value="">No employees found</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading employees:', error);
                    document.getElementById('deleteEmployeeSelect').innerHTML = '<option value="">Error loading employees</option>';
                });
        }

        // Delete ID OTP Timer Functions
        let deleteOtpTimerInterval = null;
        let deleteOtpTimeRemaining = 180; // 3 minutes in seconds
        
        function formatDeleteTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function startDeleteOtpTimer() {
            // Clear any existing timer
            if (deleteOtpTimerInterval) {
                clearInterval(deleteOtpTimerInterval);
            }
            
            deleteOtpTimeRemaining = 180; // Reset to 3 minutes
            const timerElement = document.getElementById('deleteOtpTimer');
            
            // Update timer immediately
            timerElement.textContent = `(Time remaining: ${formatDeleteTime(deleteOtpTimeRemaining)})`;
            timerElement.style.color = '#e74c3c';
            
            // Update timer every second
            deleteOtpTimerInterval = setInterval(function() {
                deleteOtpTimeRemaining--;
                
                if (deleteOtpTimeRemaining > 0) {
                    timerElement.textContent = `(Time remaining: ${formatDeleteTime(deleteOtpTimeRemaining)})`;
                    if (deleteOtpTimeRemaining <= 30) {
                        timerElement.style.color = '#e74c3c'; // Red when less than 30 seconds
                    } else {
                        timerElement.style.color = '#27ae60'; // Green otherwise
                    }
                } else {
                    // Timer expired
                    clearInterval(deleteOtpTimerInterval);
                    deleteOtpTimerInterval = null;
                    timerElement.textContent = '(OTP Expired)';
                    timerElement.style.color = '#e74c3c';
                    document.getElementById('deleteOtpInput').disabled = true;
                    document.getElementById('deleteVerifyOtpBtn').disabled = true;
                    document.getElementById('deleteOtpVerifyStatus').textContent = 'OTP has expired. Please request a new OTP.';
                    document.getElementById('deleteOtpVerifyStatus').style.color = '#e74c3c';
                    document.getElementById('deleteOtpVerifyStatus').style.display = 'block';
                }
            }, 1000);
        }
        
        function stopDeleteOtpTimer() {
            if (deleteOtpTimerInterval) {
                clearInterval(deleteOtpTimerInterval);
                deleteOtpTimerInterval = null;
            }
            const timerElement = document.getElementById('deleteOtpTimer');
            if (timerElement) {
                timerElement.textContent = '';
            }
        }
        
        // Delete ID OTP Handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Request OTP button handler for Delete ID
            const deleteRequestOtpBtn = document.getElementById('deleteRequestOtpBtn');
            if (deleteRequestOtpBtn) {
                deleteRequestOtpBtn.addEventListener('click', function() {
                    deleteRequestOtpBtn.disabled = true;
                    deleteRequestOtpBtn.textContent = 'Sending OTP...';
                    
                    fetch('/request_delete_id_otp', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('deleteOtpRequestStatus').textContent = 'OTP sent successfully! Please check the authorized email.';
                            document.getElementById('deleteOtpRequestStatus').style.display = 'block';
                            document.getElementById('deleteOtpRequestStatus').style.color = '#27ae60';
                            document.getElementById('deleteOtpVerificationSection').style.display = 'block';
                            deleteRequestOtpBtn.style.display = 'none';
                            // Start the countdown timer
                            startDeleteOtpTimer();
                        } else {
                            document.getElementById('deleteOtpRequestStatus').textContent = data.message || 'Failed to send OTP. Please try again.';
                            document.getElementById('deleteOtpRequestStatus').style.display = 'block';
                            document.getElementById('deleteOtpRequestStatus').style.color = '#e74c3c';
                            deleteRequestOtpBtn.disabled = false;
                            deleteRequestOtpBtn.textContent = 'Request OTP';
                        }
                    })
                    .catch(error => {
                        console.error('Error requesting OTP:', error);
                        document.getElementById('deleteOtpRequestStatus').textContent = 'Error requesting OTP. Please try again.';
                        document.getElementById('deleteOtpRequestStatus').style.display = 'block';
                        document.getElementById('deleteOtpRequestStatus').style.color = '#e74c3c';
                        deleteRequestOtpBtn.disabled = false;
                        deleteRequestOtpBtn.textContent = 'Request OTP';
                    });
                });
            }
            
            // Verify OTP button handler for Delete ID
            const deleteVerifyOtpBtn = document.getElementById('deleteVerifyOtpBtn');
            if (deleteVerifyOtpBtn) {
                deleteVerifyOtpBtn.addEventListener('click', function() {
                    const otpInput = document.getElementById('deleteOtpInput');
                    const otpValue = otpInput.value.trim();
                    
                    if (!otpValue) {
                        document.getElementById('deleteOtpVerifyStatus').textContent = 'Please enter the OTP.';
                        document.getElementById('deleteOtpVerifyStatus').style.color = '#e74c3c';
                        document.getElementById('deleteOtpVerifyStatus').style.display = 'block';
                        return;
                    }
                    
                    deleteVerifyOtpBtn.disabled = true;
                    deleteVerifyOtpBtn.textContent = 'Verifying...';
                    
                    const formData = new FormData();
                    formData.append('otp', otpValue);
                    
                    fetch('/verify_delete_id_otp', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Stop the timer when OTP is verified
                            stopDeleteOtpTimer();
                            document.getElementById('deleteOtpTimer').textContent = '(OTP Verified)';
                            document.getElementById('deleteOtpTimer').style.color = '#27ae60';
                            
                            document.getElementById('deleteOtpVerifyStatus').textContent = 'OTP verified successfully! You can now delete employee ID.';
                            document.getElementById('deleteOtpVerifyStatus').style.color = '#27ae60';
                            document.getElementById('deleteOtpVerifyStatus').style.display = 'block';
                            document.getElementById('deleteIdBtn').disabled = false;
                            document.getElementById('deleteIdBtn').style.opacity = '1';
                            document.getElementById('deleteIdBtn').style.cursor = 'pointer';
                            otpInput.disabled = true;
                            deleteVerifyOtpBtn.disabled = true;
                            deleteVerifyOtpBtn.textContent = 'OTP Verified';
                            deleteVerifyOtpBtn.style.backgroundColor = '#27ae60';
                        } else {
                            document.getElementById('deleteOtpVerifyStatus').textContent = data.message || 'Invalid OTP. Please try again.';
                            document.getElementById('deleteOtpVerifyStatus').style.color = '#e74c3c';
                            document.getElementById('deleteOtpVerifyStatus').style.display = 'block';
                            deleteVerifyOtpBtn.disabled = false;
                            deleteVerifyOtpBtn.textContent = 'Verify OTP';
                            otpInput.value = '';
                            otpInput.focus();
                        }
                    })
                    .catch(error => {
                        console.error('Error verifying OTP:', error);
                        document.getElementById('deleteOtpVerifyStatus').textContent = 'Error verifying OTP. Please try again.';
                        document.getElementById('deleteOtpVerifyStatus').style.color = '#e74c3c';
                        document.getElementById('deleteOtpVerifyStatus').style.display = 'block';
                        deleteVerifyOtpBtn.disabled = false;
                        deleteVerifyOtpBtn.textContent = 'Verify OTP';
                    });
                });
            }
        });
        
        function deleteSelectedUser() {
            // Check if OTP is verified
            const deleteIdBtn = document.getElementById('deleteIdBtn');
            if (deleteIdBtn && deleteIdBtn.disabled) {
                alert('Please verify OTP first before deleting employee ID.');
                return;
            }
            
            const select = document.getElementById('deleteEmployeeSelect');
            const userId = select.value;
            const userName = select.options[select.selectedIndex]?.text || '';

            if (!userId) {
                alert('Please select an employee to delete');
                return;
            }

            if (!confirm(`Are you sure you want to delete the ID for ${userName}? This action cannot be undone.`)) {
                return;
            }

            deleteIdBtn.disabled = true;
            deleteIdBtn.textContent = 'Deleting...';

            fetch('/api/delete_user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User deleted successfully');
                    loadDeleteEmployeeList();
                    loadEmployeeList();
                    closeDeleteIdModal();
                } else {
                    alert('Error deleting user: ' + (data.message || 'Unknown error'));
                    deleteIdBtn.disabled = false;
                    deleteIdBtn.textContent = 'Delete ID';
                }
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                alert('Error deleting user. Please try again.');
            });
        }

    </script>
</body>
</html>
